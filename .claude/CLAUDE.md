# Claude Code Guidelines for facet

## Git Workflow - CRITICAL

**NEVER merge to main directly.** Always:

1. Create a branch for changes
2. Push the branch
3. Open a PR using `gh pr create`
4. Let the human merge the PR

Use `gh` commands to check CI status, not to bypass the workflow.

## Testing

- Use `cargo nextest run` instead of `cargo test` (required by facet-testhelpers)
- Run `just nostd-ci` or check nostd target manually for no_std compatibility
- For crashes/segfaults: `cargo nextest run --profile valgrind <filters>` (pre-configured wrapper)

## Benchmarking - IMPORTANT

**Benchmarks are defined in `facet-json/benches/benchmarks.kdl`, NOT the generated `.rs` files.**

Quick commands:
```bash
# Run all benchmarks with report
cargo xtask bench

# Run specific benchmark (e.g., flatten_2enums)
cargo bench --bench unified_benchmarks_divan -- flatten_2enums

# With Tier-2 diagnostics
FACET_TIER2_DIAG=1 cargo bench --bench unified_benchmarks_divan -- flatten_2enums 2>&1 | grep TIER

# Check success rate
cargo bench --bench unified_benchmarks_divan -- flatten_2enums 2>&1 | grep TIER_STATS
```

**See `.claude/skills/benchmarking.md` for full documentation.**

## Editing Files - CRITICAL

**NEVER use sed for file editing.** It's destructive and error-prone.

- Use the Edit tool for targeted changes
- Use the Write tool for full rewrites
- If you're getting lazy, use the Task tool - subagents will think for you

## facet-format Migration

The codebase is migrating to a new serialization architecture:

| Crate | Status |
|-------|--------|
| `facet-json` | Legacy (still works, being phased out) |
| `facet-format-json` | Future (use this for new code) |
| `facet-format` | Core Serializer/Deserializer traits, includes JIT |
| `facet-format-suite` | Test suite pulled in by `facet-format-{format}` crates |

When writing new code, prefer `facet-format-json` over `facet-json`.

## No Serde - CRITICAL

Use facet crates instead of serde-based crates:

| Instead of | Use |
|------------|-----|
| `serde_json` | `facet-json` |
| `serde_yaml_ng` / `serde_yaml` | `facet-yaml` |
| `toml` (secretly serde) | `facet-toml` (or consider `facet-kdl` - TOML is not great) |
| `quick-xml` | `facet-xml` |
| `clap` | `facet-args` |

If you find bugs in facet crates, **fix them** - don't fall back to serde.

**Acceptable serde uses:**
- Dev-deps/build-deps we don't control
- Benchmarks where serde_json is the baseline

## Problem Handling - CRITICAL

**DO NOT silence problems. DO NOT work around tasks. Give negative feedback EARLY and OFTEN.**

- `Box::leak()` => **NO, BAD, NEVER** - don't leak memory to avoid fixing interfaces
- `// TODO: stop cheating` => **NO, BAD, NEVER** - don't leave broken code with comments
- `let _ = unused_var;` => **NO, BAD, NEVER** - don't silence warnings, fix the code
- `#[allow(dead_code)]` => **NO, BAD, NEVER** - remove unused code, don't hide it
- `todo!("this is broken because X")` => **YES, GOOD** - fail fast with clear message
- Fix the interface/design if it doesn't work, don't patch around it

## Generated Folders - DO NOT EDIT

**`bench-reports/perf/`** is generated by `cargo xtask bench --index`:
- SPA source: **`/scripts/app.js`** (edit THIS, not the copy)
- Styles source: **`/scripts/shared-styles.css`**
- Data pulled from `facet-rs/perf.facet.rs` repo (gh-pages branch)

**NEVER edit files in `bench-reports/perf/`** - they will be overwritten. Edit `/scripts/` instead.

## Skills - CHECK THESE FIRST

**`.claude/skills/`** contains specialized guidance - **check before starting domain-specific work:**

| Skill | When to Read |
|-------|-------------|
| **benchmarking.md** | Before running/adding benchmarks, checking perf |
| **debug-with-valgrind.md** | When encountering crashes, SIGSEGV, memory errors |
| **profiling.md** | For performance profiling workflows |
| **use-facet-crates.md** | When using facet crates, understanding architecture |

**ALWAYS check skills/ before:**
- Running or modifying benchmarks
- Debugging crashes or memory issues
- Performance optimization work
- Using unfamiliar facet subsystems

Don't waste time or duplicate information - check skills first.

