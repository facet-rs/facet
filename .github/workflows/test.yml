# HANDWRITTEN: facet-dev hands off my pipelines

name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  test:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - name: Install system dependencies
        run: apt-get update && apt-get install -y zlib1g-dev

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run tests with coverage
        shell: bash
        run: |
          # Install nightly for coverage with doctests
          rustup toolchain install nightly
          
          # Run unit and integration tests with coverage
          cargo +nightly llvm-cov --no-report nextest --features ci
          
          # Run doc tests with coverage (requires nightly)
          cargo +nightly llvm-cov --no-report --doc --features ci
          
          # Generate merged coverage report
          mkdir coverage
          cargo +nightly llvm-cov report --doctests --lcov --output-path coverage/lcov.info

      - name: ✨ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  nostd:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nostd tests
        shell: bash
        run: |
          just nostd-ci

  miri:
    runs-on: depot-ubuntu-24.04-64

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-miri-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run miri
        shell: bash
        run: |
          export CI=true
          just miri

  valgrind:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - name: Install valgrind and nodejs
        run: apt-get update && apt-get install -y valgrind nodejs

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run facet-json tests under valgrind
        shell: bash
        run: |
          just valgrind-facet-json

  gungraun:
    runs-on: depot-ubuntu-24.04-32

    steps:
      - uses: actions/checkout@v5

      - name: Install valgrind (required by gungraun)
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - uses: Swatinem/rust-cache@v2

      - name: Install gungraun-runner
        run: cargo install gungraun-runner@0.17.0

      - name: ✨ Run gungraun JIT benchmarks
        shell: bash
        run: |
          cargo bench --bench unified_benchmarks_gungraun --features cranelift -p facet-json

  benchmarks:
    runs-on: depot-ubuntu-24.04-32
    continue-on-error: true  # Don't block merges

    permissions:
      contents: write  # For pushing to perf.facet.rs

    concurrency:
      group: perf-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full git history

      - name: Install valgrind (required by gungraun)
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - uses: Swatinem/rust-cache@v2

      - name: Install gungraun-runner
        run: cargo install gungraun-runner@0.17.0

      - name: ✨ Run benchmarks
        shell: bash
        run: |
          cargo xtask bench

      - name: Extract metadata
        id: meta
        shell: bash
        env:
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          # Use head_ref for PRs (actual branch name), ref_name for direct pushes
          BRANCH_NAME="${HEAD_REF:-$REF_NAME}"

          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/_/g')" >> $GITHUB_OUTPUT
          echo "branch_original=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUM:-}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "timestamp_display=$(date -u +%Y-%m-%d\ %H:%M\ UTC)" >> $GITHUB_OUTPUT

      - name: Set up SSH deploy key
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.PERF_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/perf_deploy_key
          chmod 600 ~/.ssh/perf_deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global core.sshCommand "ssh -i ~/.ssh/perf_deploy_key -o IdentitiesOnly=yes"

      - name: Clone perf repository
        shell: bash
        run: |
          git clone git@github.com:facet-rs/perf.facet.rs.git /tmp/perf
          cd /tmp/perf
          git checkout gh-pages || git checkout --orphan gh-pages

      - name: Copy reports
        shell: bash
        env:
          BRANCH: ${{ steps.meta.outputs.branch }}
          BRANCH_ORIG: ${{ steps.meta.outputs.branch_original }}
          COMMIT: ${{ steps.meta.outputs.commit }}
          COMMIT_SHORT: ${{ steps.meta.outputs.commit_short }}
          TIMESTAMP: ${{ steps.meta.outputs.timestamp }}
          TIMESTAMP_DISPLAY: ${{ steps.meta.outputs.timestamp_display }}
          PR_NUMBER: ${{ steps.meta.outputs.pr_number }}
        run: |
          DEST="/tmp/perf/$BRANCH/$COMMIT"
          mkdir -p "$DEST"
          cp bench-reports/report-*.html "$DEST/"
          cp bench-reports/*.txt "$DEST/" || true
          cp bench-reports/perf-data-*.json "$DEST/" || true

          # Save metadata as JSON
          printf '{\n  "commit": "%s",\n  "commit_short": "%s",\n  "branch": "%s",\n  "branch_original": "%s",\n  "pr_number": "%s",\n  "timestamp": "%s",\n  "timestamp_display": "%s"\n}\n' \
            "$COMMIT" "$COMMIT_SHORT" "$BRANCH" "$BRANCH_ORIG" "$PR_NUMBER" "$TIMESTAMP" "$TIMESTAMP_DISPLAY" \
            > "$DEST/metadata.json"

          # Copy fonts to shared location
          mkdir -p /tmp/perf/fonts
          find bench-reports -name "*.ttf" -exec cp {} /tmp/perf/fonts/ \; || true

          # Copy scripts to root
          cp scripts/perf-nav.js /tmp/perf/nav.js
          cp scripts/app.js /tmp/perf/app.js

          # Copy favicon files
          cp docs/static/favicon.png /tmp/perf/favicon.png
          cp docs/static/favicon.ico /tmp/perf/favicon.ico

          # Update latest symlink
          cd "/tmp/perf/$BRANCH"
          rm -f latest
          ln -s "$COMMIT" latest

      - name: Generate index pages
        shell: bash
        run: |
          cargo run --release -p perf-index-generator -- /tmp/perf

      - name: Commit and push
        shell: bash
        working-directory: /tmp/perf
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add benchmarks for ${{ steps.meta.outputs.branch }}@${{ steps.meta.outputs.commit_short }}" || exit 0

          # Retry logic for concurrent pushes
          for i in 1 2 3; do
            if git push origin gh-pages; then
              echo "✅ Published to https://perf.facet.rs/${{ steps.meta.outputs.branch }}/${{ steps.meta.outputs.commit }}"
              exit 0
            fi
            echo "Push failed, retrying ($i/3)..."
            sleep $((i * 2))
            git pull --rebase origin gh-pages || true
          done
          exit 1

  nightly:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-miri-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nightly feature tests (simd auto-detected)
        shell: bash
        run: |
          cargo nextest run --package facet-core

  msrv:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check MSRV
        shell: bash
        run: |
          just msrv

  docs:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check documentation
        shell: bash
        env:
          RUSTDOCFLAGS: -D warnings
        run: |
          just docs

  lockfile:
    runs-on: depot-ubuntu-24.04-4

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check lockfile is updated
        shell: bash
        run: |
          cargo update --workspace --locked

  clippy:
    runs-on: depot-ubuntu-24.04-16

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run clippy
        shell: bash
        run: |
          cargo clippy --workspace --all-features --all-targets --keep-going -- -D warnings --allow deprecated

  test-macos:
    runs-on: depot-macos-latest
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ✨ Run nextest tests (macOS)
        shell: bash
        run: |
          cargo nextest run --features ci

  check-windows:
    runs-on: depot-windows-2022
    steps:
      - uses: actions/checkout@v5

      - name: ✨ Run cargo check (Windows)
        shell: bash
        run: |
          cargo check
