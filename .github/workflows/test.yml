# HANDWRITTEN: facet-dev hands off my pipelines

name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  test:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - name: Install system dependencies
        run: apt-get update && apt-get install -y zlib1g-dev

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run tests with coverage
        shell: bash
        run: |
          # Install nightly for coverage with doctests
          rustup toolchain install nightly
          
          # Run unit and integration tests with coverage
          cargo +nightly llvm-cov --no-report nextest --features ci
          
          # Run doc tests with coverage (requires nightly)
          cargo +nightly llvm-cov --no-report --doc --features ci
          
          # Generate merged coverage report
          mkdir coverage
          cargo +nightly llvm-cov report --doctests --lcov --output-path coverage/lcov.info

      - name: ✨ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  nostd:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nostd tests
        shell: bash
        run: |
          just nostd-ci

  miri:
    runs-on: depot-ubuntu-24.04-64

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-miri-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run miri
        shell: bash
        run: |
          export CI=true
          just miri

  valgrind:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - name: Install valgrind and nodejs
        run: apt-get update && apt-get install -y valgrind nodejs

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run facet-json tests under valgrind
        shell: bash
        run: |
          just valgrind-facet-json

  gungraun:
    runs-on: depot-ubuntu-24.04-32

    steps:
      - uses: actions/checkout@v5

      - name: Install valgrind (required by gungraun)
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - uses: Swatinem/rust-cache@v2

      - name: Install gungraun-runner
        run: cargo install gungraun-runner@0.17.0

      - name: ✨ Run gungraun JIT benchmarks
        shell: bash
        run: |
          cargo bench --bench gungraun_jit --features cranelift -p facet-json

  nightly:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-miri-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nightly feature tests (simd auto-detected)
        shell: bash
        run: |
          cargo nextest run --package facet-core

  msrv:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check MSRV
        shell: bash
        run: |
          just msrv

  docs:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check documentation
        shell: bash
        env:
          RUSTDOCFLAGS: -D warnings
        run: |
          just docs

  lockfile:
    runs-on: depot-ubuntu-24.04-4

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check lockfile is updated
        shell: bash
        run: |
          cargo update --workspace --locked

  clippy:
    runs-on: depot-ubuntu-24.04-16

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run clippy
        shell: bash
        run: |
          cargo clippy --workspace --all-features --all-targets --keep-going -- -D warnings --allow deprecated

  test-macos:
    runs-on: depot-macos-latest
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ✨ Run nextest tests (macOS)
        shell: bash
        run: |
          cargo nextest run --features ci

  check-windows:
    runs-on: depot-windows-2022
    steps:
      - uses: actions/checkout@v5

      - name: ✨ Run cargo check (Windows)
        shell: bash
        run: |
          cargo check
