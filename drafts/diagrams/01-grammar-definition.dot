// Grammar Definition Time
// Render: dot -Tsvg 01-grammar-definition.dot -o 01-grammar-definition.svg

digraph grammar_definition {
    label="Grammar Definition Time";
    labelloc="t";
    fontsize=20;
    fontname="Helvetica-Bold";

    node [shape=box, fontname="Monaco, Consolas, Courier", fontsize=11];
    edge [fontname="Helvetica", fontsize=10];

    rankdir=LR;
    nodesep=0.8;
    ranksep=1.2;

    // Extension crate input
    grammar [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#ffe4c4"><b>Input: facet-kdl/src/lib.rs</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet::<font color="#8250df">define_attr_grammar!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">Attr</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        Child,                <font color="#6e7781">// unit</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        Rename(<font color="#0550ae">&amp;'static str</font>), <font color="#6e7781">// newtype</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        Column(<font color="#0550ae">Column</font>),       <font color="#6e7781">// struct</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Column</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> primary_key: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> name: <font color="#0550ae">Option</font>&lt;<font color="#0550ae">&amp;'static str</font>&gt;,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff8f0"];

    // Proc-macro processing
    make_parse [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td bgcolor="#e8e8f4"><b>facet-macros-impl</b></td></tr>
<tr><td><font face="Monaco">::facet::<font color="#8250df">__make_parse_attr!</font></font></td></tr>
<tr><td>(grammar compiler)</td></tr>
</table>
    >, style=filled, fillcolor="#e8e8f4"];

    // Generated output - single combined node
    generated [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>Generated in facet-kdl</b></td></tr>
<tr><td align="left" bgcolor="#e8f5e9"><b>1. Runtime types</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub enum</font> <font color="#0550ae">Attr</font> { Child, Rename(<font color="#0550ae">...</font>), Column(<font color="#0550ae">Column</font>) }</font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub struct</font> <font color="#0550ae">Column</font> { primary_key: <font color="#0550ae">bool</font>, name: <font color="#0550ae">Option</font>&lt;...&gt; }</font></td></tr>
<tr><td align="left" bgcolor="#fff3cd"><b>2. THE COMPILED GRAMMAR (declarative macro)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">macro_rules!</font> <font color="#8250df">__parse_attr</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    (child) =&gt; { <font color="#0550ae">ExtensionAttr</font> { ns:<font color="#0a3069">"kdl"</font>, key:<font color="#0a3069">"child"</font>, data:<font color="#cf222e">&amp;</font>() } };</font></td></tr>
<tr><td align="left"><font face="Monaco">    (rename = <font color="#953800">$v</font>:literal) =&gt; { <font color="#0550ae">ExtensionAttr</font> { ... data:<font color="#cf222e">&amp;</font><font color="#953800">$v</font> } };</font></td></tr>
<tr><td align="left"><font face="Monaco">    (column($(<font color="#953800">$f</font>:tt)*)) =&gt; {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#953800">$crate</font>::<font color="#8250df">__dispatch_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@struct</font> { <font color="#0550ae">Column</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@schema</font> { primary_key:<font color="#0550ae">bool</font>=<font color="#0550ae">false</font>, name:<font color="#0550ae">opt_str</font>=<font color="#0550ae">None</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@input</font> { $(<font color="#953800">$f</font>)* }  <font color="#6e7781">// &lt;-- user's tokens</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        }</font></td></tr>
<tr><td align="left"><font face="Monaco">    };</font></td></tr>
<tr><td align="left"><font face="Monaco">    (<font color="#953800">$unk</font>:ident $(<font color="#953800">$r</font>:tt)*) =&gt; { <font color="#8250df">__attr_error!</font>(<font color="#8250df">@known</font>{...} <font color="#8250df">@got</font>{<font color="#953800">$unk</font>}) };</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
<tr><td align="left" bgcolor="#e8f5e9"><b>3. Re-exports (macro hygiene)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub use</font> ::facet::{<font color="#8250df">__dispatch_attr</font>, <font color="#8250df">__attr_error</font>, ...};</font></td></tr>
</table>
    >, style=filled, fillcolor="#f0fff0"];

    // Edges
    grammar -> make_parse [label="compiles via", color="#4169e1", penwidth=2];
    make_parse -> generated [label="generates", color="#228b22", penwidth=2];
}
