// Grammar Definition Time
// Render: dot -Tsvg 01-grammar-definition.dot -o 01-grammar-definition.svg

digraph grammar_definition {
    label="Grammar Definition Time";
    labelloc="t";
    fontsize=20;
    fontname="Helvetica-Bold";

    node [shape=box, fontname="Monaco, Consolas, Courier", fontsize=11];
    edge [fontname="Helvetica", fontsize=10];

    rankdir=LR;
    nodesep=0.8;
    ranksep=1.2;

    // Extension crate input
    grammar [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#ffe4c4"><b>Input: facet-kdl/src/lib.rs</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet::<font color="#8250df">define_attributes!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">mod</font> <font color="#0550ae">attrs</font>;  <font color="#6e7781">// generated submodule</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">Attribute</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#6e7781">// target = field | container | both (default)</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        #[<font color="#8250df">target</font>(both)]</font></td></tr>
<tr><td align="left"><font face="Monaco">        Child,                 <font color="#6e7781">// unit variant</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        #[<font color="#8250df">target</font>(field)]</font></td></tr>
<tr><td align="left"><font face="Monaco">        Rename(<font color="#0550ae">&amp;'static str</font>),  <font color="#6e7781">// newtype</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        #[<font color="#8250df">target</font>(field)]</font></td></tr>
<tr><td align="left"><font face="Monaco">        Column(<font color="#0550ae">Column</font>),        <font color="#6e7781">// struct</font></font></td></tr>
<tr><td align="left"><font face="Monaco">        #[<font color="#8250df">target</font>(container)]</font></td></tr>
<tr><td align="left"><font face="Monaco">        Transparent,           <font color="#6e7781">// container-only</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Column</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> primary_key: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> name: <font color="#0550ae">Option</font>&lt;<font color="#0550ae">&amp;'static str</font>&gt;,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff8f0"];

    // Proc-macro processing
    make_parse [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td bgcolor="#e8e8f4"><b>facet-macros-impl</b></td></tr>
<tr><td><font face="Monaco">::facet::<font color="#8250df">__make_parse_attr!</font></font></td></tr>
<tr><td>(grammar compiler)</td></tr>
</table>
    >, style=filled, fillcolor="#e8e8f4"];

    // Generated output - single combined node
    generated [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>Generated in facet-kdl</b></td></tr>
<tr><td align="left" bgcolor="#e8f5e9"><b>1. Runtime types (in submodule)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub mod</font> <font color="#0550ae">attrs</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">Attribute</font> { Child, Rename(<font color="#0550ae">...</font>), Column(<font color="#0550ae">...</font>) }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Column</font> { primary_key: <font color="#0550ae">bool</font>, ... }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
<tr><td align="left" bgcolor="#fff3cd"><b>2. THE COMPILED GRAMMAR (declarative macro)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">macro_rules!</font> <font color="#8250df">__parse_attr</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    (<font color="#8250df">@context</font>{<font color="#953800">$ctx</font>:ident} <font color="#953800">$name</font>:ident $(<font color="#953800">$rest</font>:tt)*) =&gt; {</font></td></tr>
<tr><td align="left"><font face="Monaco">        ::facet::<font color="#8250df">__dispatch_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@ns</font> { <font color="#0a3069">"kdl"</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@context</font> { <font color="#953800">$ctx</font> } <font color="#6e7781">// field | container</font></font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@variants</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">                child: unit <font color="#8250df">@target</font>(both),</font></td></tr>
<tr><td align="left"><font face="Monaco">                rename: newtype <font color="#8250df">@target</font>(field),</font></td></tr>
<tr><td align="left"><font face="Monaco">                column: rec { pk:<font color="#0550ae">bool</font>, name:<font color="#0550ae">opt_str</font> } <font color="#8250df">@target</font>(field),</font></td></tr>
<tr><td align="left"><font face="Monaco">                transparent: unit <font color="#8250df">@target</font>(container),</font></td></tr>
<tr><td align="left"><font face="Monaco">            }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@name</font> { <font color="#953800">$name</font> } <font color="#8250df">@rest</font> { $(<font color="#953800">$rest</font>)* }</font></td></tr>
<tr><td align="left"><font face="Monaco">        }</font></td></tr>
<tr><td align="left"><font face="Monaco">    };</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
<tr><td align="left" bgcolor="#e8f5e9"><b>3. Re-exports (macro hygiene)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub use</font> ::facet::{<font color="#8250df">__dispatch_attr</font>, <font color="#8250df">__attr_error</font>, ...};</font></td></tr>
</table>
    >, style=filled, fillcolor="#f0fff0"];

    // Edges
    grammar -> make_parse [label="compiles via", color="#4169e1", penwidth=2];
    make_parse -> generated [label="generates", color="#228b22", penwidth=2];
}
