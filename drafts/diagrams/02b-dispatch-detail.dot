// __dispatch_attr! Expansion Detail
// Render: dot -Tsvg 02b-dispatch-detail.dot -o 02b-dispatch-detail.svg

digraph dispatch_detail {
    label="__dispatch_attr! Expansion Detail";
    labelloc="t";
    fontsize=20;
    fontname="Helvetica-Bold";

    node [shape=box, fontname="Monaco, Consolas, Courier", fontsize=11];
    edge [fontname="Helvetica", fontsize=10];

    rankdir=TB;

    // Input
    input [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#fff3cd"><b>Input from __parse_attr!</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet::<font color="#8250df">__dispatch_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@namespace</font> { <font color="#953800">$crate</font> }  <font color="#6e7781">// = ::orm</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@enum_name</font> { <font color="#0550ae">Attr</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@variants</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        skip: unit,</font></td></tr>
<tr><td align="left"><font face="Monaco">        rename: newtype <font color="#0550ae">&amp;'static str</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        column: rec <font color="#0550ae">Column</font> { primary_key: <font color="#0550ae">bool</font>, name: opt_str }</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@name</font> { column }  <font color="#6e7781">// from user's attr</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@rest</font> { (primary_key) }  <font color="#6e7781">// remaining tokens</font></font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff9e6"];

    // Decision
    lookup [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td><b>Variant Lookup</b></td></tr>
<tr><td>Match <font face="Monaco">column</font> against known variants</td></tr>
</table>
    >, shape=diamond, style=filled, fillcolor="#e8e8f4"];

    // Branch: found struct
    found_struct [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>Found: struct variant (column) ✓</b></td></tr>
<tr><td align="left">Forward to <font face="Monaco" color="#8250df">__build_struct_fields!</font></td></tr>
</table>
    >, style=filled, fillcolor="#e8f5e9"];

    // __build_struct_fields
    build_fields [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#fff3cd"><b>::facet::__build_struct_fields!</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet::<font color="#8250df">__build_struct_fields!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@namespace</font> { ::orm }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@struct_name</font> { <font color="#0550ae">Column</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@fields</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        primary_key: <font color="#0550ae">bool</font> = <font color="#0550ae">false</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        name: opt_str = <font color="#0550ae">None</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@input</font> { (primary_key) }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff9e6"];

    // Field parsing
    field_parse [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td bgcolor="#e8e8f4"><b>Field Parsing</b></td></tr>
<tr><td align="left">For each token in input:</td></tr>
<tr><td align="left"><font face="Monaco">primary_key</font> → set <font face="Monaco">primary_key = <font color="#0550ae">true</font></font></td></tr>
<tr><td align="left"><font face="Monaco">name = <font color="#0a3069">"foo"</font></font> → set <font face="Monaco">name = <font color="#0550ae">Some</font>(<font color="#0a3069">"foo"</font>)</font></td></tr>
</table>
    >, style=filled, fillcolor="#e8e8f4"];

    // Final output
    output [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>Final Output</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet_core::<font color="#0550ae">ExtensionAttr</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    ns: <font color="#0a3069">"orm"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    key: <font color="#0a3069">"column"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    data: <font color="#cf222e">&amp;</font>::orm::<font color="#0550ae">Column</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        primary_key: <font color="#0550ae">true</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        name: <font color="#0550ae">None</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    },</font></td></tr>
<tr><td align="left"><font face="Monaco">    shape: &lt;::orm::<font color="#0550ae">Column</font>&gt;::SHAPE,</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#e8f5e9"];

    // Not found branch
    not_found [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td bgcolor="#f8d7da"><b>Not found?</b></td></tr>
<tr><td><font face="Monaco" color="#8250df">__attr_error!</font> with suggestions</td></tr>
</table>
    >, style=filled, fillcolor="#f8d7da"];

    // Edges
    input -> lookup;
    lookup -> found_struct [label="struct variant", color="#228b22", penwidth=2];
    lookup -> not_found [label="unknown", style=dashed, color="#dc3545"];
    found_struct -> build_fields;
    build_fields -> field_parse;
    field_parse -> output [color="#228b22", penwidth=2];
}
