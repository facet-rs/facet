// Storage Model: Unified Attr type
// Render: dot -Tsvg 04-storage-model.dot -o 04-storage-model.svg

digraph storage_model {
    label="Storage Model: Unified Attr type";
    labelloc="t";
    fontsize=20;
    fontname="Helvetica-Bold";

    node [shape=box, fontname="Monaco, Consolas, Courier", fontsize=11];
    edge [fontname="Helvetica", fontsize=10];

    rankdir=LR;

    // Input attributes
    subgraph cluster_input {
        label="User writes";
        fontname="Helvetica";
        style=dashed;

        builtin [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#fff8f0"><b>Built-in attrs (no namespace)</b></td></tr>
<tr><td align="left"><font face="Monaco">#[<font color="#8250df">facet</font>(skip)]</font></td></tr>
<tr><td align="left"><font face="Monaco">#[<font color="#8250df">facet</font>(rename = <font color="#0a3069">"foo"</font>)]</font></td></tr>
</table>
        >, style=filled, fillcolor="#fff8f0"];

        extension [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#f4e8e8"><b>Namespaced attrs</b></td></tr>
<tr><td align="left"><font face="Monaco">#[<font color="#8250df">facet</font>(kdl::child)]</font></td></tr>
<tr><td align="left"><font face="Monaco">#[<font color="#8250df">facet</font>(orm::column(pk))]</font></td></tr>
</table>
        >, style=filled, fillcolor="#f4e8e8"];
    }

    // Output
    subgraph cluster_output {
        label="All become ::facet_core::Attribute";
        fontname="Helvetica";
        style=dashed;

        ext1 [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left"><font face="Monaco">::facet_core::<font color="#0550ae">Attribute</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    ns: <font color="#0550ae">None</font>,  <font color="#6e7781">// None = built-in</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    key: <font color="#0a3069">"skip"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    data: <font color="#cf222e">&amp;</font>() <font color="#cf222e">as</font> *<font color="#cf222e">const</font> (),</font></td></tr>
<tr><td align="left"><font face="Monaco">    shape: &lt;()&gt;::SHAPE,</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
        >, style=filled, fillcolor="#e8f5e9"];

        ext2 [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left"><font face="Monaco">::facet_core::<font color="#0550ae">Attribute</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    ns: <font color="#0550ae">Some</font>(<font color="#0a3069">"kdl"</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">    key: <font color="#0a3069">"child"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    data: <font color="#cf222e">&amp;</font>() <font color="#cf222e">as</font> *<font color="#cf222e">const</font> (),</font></td></tr>
<tr><td align="left"><font face="Monaco">    shape: &lt;()&gt;::SHAPE,</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
        >, style=filled, fillcolor="#e8f5e9"];
    }

    // Final storage - show both Field and container
    subgraph cluster_storage {
        label="Stored in Shape metadata";
        fontname="Helvetica";
        style=dashed;

        field [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>::facet_core::Field</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet_core::<font color="#0550ae">Field</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    name: <font color="#0a3069">"id"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    attributes: <font color="#cf222e">&amp;</font>[<font color="#0550ae">Attribute</font> {...}],</font></td></tr>
<tr><td align="left"><font face="Monaco">    ...</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
        >, style=filled, fillcolor="#e8f5e9"];

        container [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>::facet_core::StructType (etc)</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet_core::<font color="#0550ae">StructType</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    attributes: <font color="#cf222e">&amp;</font>[<font color="#0550ae">Attribute</font> {...}],</font></td></tr>
<tr><td align="left"><font face="Monaco">    fields: <font color="#cf222e">&amp;</font>[<font color="#0550ae">Field</font> {...}],</font></td></tr>
<tr><td align="left"><font face="Monaco">    ...</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
        >, style=filled, fillcolor="#e8f5e9"];
    }

    // Edges
    builtin -> ext1 [color="#228b22", penwidth=2];
    extension -> ext2 [color="#228b22", penwidth=2];
    ext1 -> field [color="#228b22", penwidth=2];
    ext1 -> container [color="#228b22", penwidth=2, style=dashed];
    ext2 -> field [color="#228b22", penwidth=2];
    ext2 -> container [color="#228b22", penwidth=2, style=dashed];
}
