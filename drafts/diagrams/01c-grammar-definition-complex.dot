// Grammar Definition Time (Complex Types)
// Render: dot -Tsvg 01c-grammar-definition-complex.dot -o 01c-grammar-definition-complex.svg

digraph grammar_definition_complex {
    label="Grammar Definition Time (Complex Nested Types)";
    labelloc="t";
    fontsize=20;
    fontname="Helvetica-Bold";

    node [shape=box, fontname="Monaco, Consolas, Courier", fontsize=11];
    edge [fontname="Helvetica", fontsize=10];

    rankdir=LR;
    nodesep=0.8;
    ranksep=1.2;

    // Extension crate input with complex types
    grammar [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#ffe4f0"><b>Input: facet-orm/src/lib.rs</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet::<font color="#8250df">define_attributes!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">mod</font> <font color="#0550ae">attrs</font>;</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">ns</font> <font color="#0a3069">"orm"</font>;</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">ContainerAttribute</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        Table(<font color="#0550ae">Table</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">FieldAttribute</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        Column(<font color="#0550ae">Column</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">        Index(<font color="#0550ae">Index</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">        ForeignKey(<font color="#0550ae">ForeignKey</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left" bgcolor="#fff3cd"><font face="Monaco">    <font color="#6e7781">// User-defined structs inside macro</font></font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Table</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> name: <font color="#0550ae">Option&lt;&amp;'static str&gt;</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Column</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> name: <font color="#0550ae">Option&lt;&amp;'static str&gt;</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> primary_key: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> auto_increment: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> nullable: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Index</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> name: <font color="#0550ae">Option&lt;&amp;'static str&gt;</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> unique: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">ForeignKey</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> table: <font color="#0550ae">&amp;'static str</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> column: <font color="#0550ae">&amp;'static str</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        <font color="#cf222e">pub</font> on_delete: <font color="#0550ae">Option&lt;OnDelete&gt;</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">OnDelete</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        Cascade,</font></td></tr>
<tr><td align="left"><font face="Monaco">        SetNull,</font></td></tr>
<tr><td align="left"><font face="Monaco">        Restrict,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff0f8"];

    // Proc-macro processing
    make_parse [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td bgcolor="#e8e8f4"><b>facet-macros-impl</b></td></tr>
<tr><td><font face="Monaco">::facet::<font color="#8250df">__make_parse_attr!</font></font></td></tr>
<tr><td>(grammar compiler)</td></tr>
</table>
    >, style=filled, fillcolor="#e8e8f4"];

    // Generated output
    generated [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>Generated in facet-orm</b></td></tr>
<tr><td align="left" bgcolor="#e8f5e9"><b>1. Runtime types (in submodule)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub mod</font> <font color="#0550ae">attrs</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">ContainerAttribute</font> { Table(Table) }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">FieldAttribute</font> { Column(...), ... }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Table</font> { <font color="#cf222e">pub</font> name: ... }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Column</font> { <font color="#cf222e">pub</font> name, primary_key, ... }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">Index</font> { <font color="#cf222e">pub</font> name, unique }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub struct</font> <font color="#0550ae">ForeignKey</font> { ... }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#cf222e">pub enum</font> <font color="#0550ae">OnDelete</font> { Cascade, SetNull, Restrict }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
<tr><td align="left" bgcolor="#fff3cd"><b>2. TWO COMPILED GRAMMARS (with nested struct support)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">macro_rules!</font> <font color="#8250df">__parse_container_attr</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    (<font color="#953800">$name</font>:ident $(<font color="#953800">$rest</font>:tt)*) =&gt; {</font></td></tr>
<tr><td align="left"><font face="Monaco">        ::facet::<font color="#8250df">__dispatch_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@ns</font> { <font color="#0a3069">"orm"</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@variants</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">                table: struct { name: option_str },</font></td></tr>
<tr><td align="left"><font face="Monaco">            }</font></td></tr>
<tr><td align="left"><font face="Monaco">            ...</font></td></tr>
<tr><td align="left"><font face="Monaco">        }</font></td></tr>
<tr><td align="left"><font face="Monaco">    };</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">macro_rules!</font> <font color="#8250df">__parse_field_attr</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    (<font color="#953800">$name</font>:ident $(<font color="#953800">$rest</font>:tt)*) =&gt; {</font></td></tr>
<tr><td align="left"><font face="Monaco">        ::facet::<font color="#8250df">__dispatch_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@ns</font> { <font color="#0a3069">"orm"</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@variants</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">                column: struct {</font></td></tr>
<tr><td align="left"><font face="Monaco">                    name: option_str,</font></td></tr>
<tr><td align="left"><font face="Monaco">                    primary_key: flag,</font></td></tr>
<tr><td align="left"><font face="Monaco">                    auto_increment: flag,</font></td></tr>
<tr><td align="left"><font face="Monaco">                    nullable: flag,</font></td></tr>
<tr><td align="left"><font face="Monaco">                },</font></td></tr>
<tr><td align="left"><font face="Monaco">                index: struct { name: option_str, unique: flag },</font></td></tr>
<tr><td align="left"><font face="Monaco">                foreign_key: struct {</font></td></tr>
<tr><td align="left"><font face="Monaco">                    table: str, column: str,</font></td></tr>
<tr><td align="left"><font face="Monaco">                    on_delete: option_enum { cascade, set_null, restrict },</font></td></tr>
<tr><td align="left"><font face="Monaco">                },</font></td></tr>
<tr><td align="left"><font face="Monaco">            }</font></td></tr>
<tr><td align="left"><font face="Monaco">            ...</font></td></tr>
<tr><td align="left"><font face="Monaco">        }</font></td></tr>
<tr><td align="left"><font face="Monaco">    };</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
<tr><td align="left" bgcolor="#e8f5e9"><b>3. Re-exports (macro hygiene)</b></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">pub use</font> ::facet::{<font color="#8250df">__dispatch_attr</font>, ...};</font></td></tr>
</table>
    >, style=filled, fillcolor="#f0fff0"];

    // Edges
    grammar -> make_parse [label="compiles via", color="#4169e1", penwidth=2];
    make_parse -> generated [label="generates", color="#228b22", penwidth=2];

    // Usage example
    usage [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#e6f3ff"><b>Usage Example</b></td></tr>
<tr><td align="left"><font face="Monaco">#[<font color="#8250df">derive</font>(Facet)]</font></td></tr>
<tr><td align="left"><font face="Monaco">#[facet(<font color="#0a3069">orm::table</font>(name = <font color="#0a3069">"users"</font>))]</font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">struct</font> User {</font></td></tr>
<tr><td align="left"><font face="Monaco">    #[facet(<font color="#0a3069">orm::column</font>(primary_key, auto_increment))]</font></td></tr>
<tr><td align="left"><font face="Monaco">    id: i64,</font></td></tr>
<tr><td align="left"><font face="Monaco">    #[facet(<font color="#0a3069">orm::column</font>(name = <font color="#0a3069">"user_name"</font>))]</font></td></tr>
<tr><td align="left"><font face="Monaco">    #[facet(<font color="#0a3069">orm::index</font>(unique))]</font></td></tr>
<tr><td align="left"><font face="Monaco">    username: String,</font></td></tr>
<tr><td align="left"><font face="Monaco">    #[facet(<font color="#0a3069">orm::foreign_key</font>(</font></td></tr>
<tr><td align="left"><font face="Monaco">        table = <font color="#0a3069">"roles"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        column = <font color="#0a3069">"id"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        on_delete = cascade</font></td></tr>
<tr><td align="left"><font face="Monaco">    ))]</font></td></tr>
<tr><td align="left"><font face="Monaco">    role_id: i64,</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#f0f8ff"];

    generated -> usage [label="enables", color="#666666", style=dashed, penwidth=1.5];
}
