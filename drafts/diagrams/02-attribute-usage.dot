// Attribute Usage Flow (Detailed)
// Render: dot -Tsvg 02-attribute-usage.dot -o 02-attribute-usage.svg

digraph attribute_usage {
    label="Attribute Usage Flow (Detailed)";
    labelloc="t";
    fontsize=20;
    fontname="Helvetica-Bold";

    node [shape=box, fontname="Monaco, Consolas, Courier", fontsize=10];
    edge [fontname="Helvetica", fontsize=9];

    rankdir=TB;

    // User code
    user_code [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#fff8f0"><b>1. User code</b></td></tr>
<tr><td align="left"><font face="Monaco">#[<font color="#8250df">derive</font>(::<font color="#0550ae">facet</font>::<font color="#0550ae">Facet</font>)]</font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">struct</font> <font color="#0550ae">User</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    #[<font color="#8250df">facet</font>(orm::column(primary_key))]</font></td></tr>
<tr><td align="left"><font face="Monaco">    id: <font color="#0550ae">i64</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff8f0"];

    // Derive macro parses and extracts
    derive_parse [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#e8e8f4"><b>2. facet-macros parses attribute</b></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Extracts from #[facet(orm::column(primary_key))]:</font></td></tr>
<tr><td align="left"><font face="Monaco">namespace = <font color="#0a3069">"orm"</font></font></td></tr>
<tr><td align="left"><font face="Monaco">rest = <font color="#0a3069">column(primary_key)</font></font></td></tr>
</table>
    >, style=filled, fillcolor="#e8e8f4"];

    // Generated call to namespace macro
    gen_call [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#fff3cd"><b>3. Generates call to namespace macro</b></td></tr>
<tr><td align="left"><font face="Monaco">::orm::<font color="#8250df">__parse_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@input</font> { column(primary_key) }</font></td></tr>
<tr><td align="left"><font face="Monaco">    <font color="#8250df">@ns</font> { <font color="#0a3069">"orm"</font> }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#fff9e6"];

    // __parse_attr! definition (in orm crate)
    parse_attr_def [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#f4e8e8"><b>4. orm::__parse_attr! (from define_attributes!)</b></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Generated macro contains variant list:</font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#8250df">macro_rules!</font> __parse_attr {</font></td></tr>
<tr><td align="left"><font face="Monaco">    ($(<font color="#cf222e">$</font>input:tt)*) =&gt; {</font></td></tr>
<tr><td align="left"><font face="Monaco">        ::<font color="#0550ae">facet</font>::<font color="#8250df">__dispatch_attr!</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@variants</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">                skip =&gt; <font color="#0550ae">unit</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">                rename =&gt; <font color="#0550ae">newtype</font>(<font color="#0550ae">String</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">                column =&gt; <font color="#0550ae">struct</font> { ... },</font></td></tr>
<tr><td align="left"><font face="Monaco">            }</font></td></tr>
<tr><td align="left"><font face="Monaco">            <font color="#8250df">@input</font> { $($input)* }</font></td></tr>
<tr><td align="left"><font face="Monaco">            ...</font></td></tr>
<tr><td align="left"><font face="Monaco">        }</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#f4e8e8"];

    // __dispatch_attr! matches variant
    dispatch_match [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#e8e8f4"><b>5. __dispatch_attr! matches "column"</b></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Input: column(primary_key)</font></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Scans @variants, finds:</font></td></tr>
<tr><td align="left"><font face="Monaco">    column =&gt; <font color="#0550ae">struct</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        primary_key: <font color="#0550ae">bool</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        name: <font color="#0550ae">Option</font>&lt;<font color="#0550ae">String</font>&gt;,</font></td></tr>
<tr><td align="left"><font face="Monaco">    }</font></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Variant type = struct, forwards to builder</font></td></tr>
</table>
    >, style=filled, fillcolor="#e8e8f4"];

    // Build struct fields
    build_struct [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#e8f0e8"><b>6. __build_struct_fields! parses tokens</b></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Input tokens: (primary_key)</font></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// For each field in struct def:</font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">let</font> primary_key = <font color="#0550ae">false</font>; <font color="#6e7781">// default</font></font></td></tr>
<tr><td align="left"><font face="Monaco"><font color="#cf222e">let</font> name = <font color="#0550ae">None</font>;         <font color="#6e7781">// default</font></font></td></tr>
<tr><td align="left"><font face="Monaco" color="#6e7781">// Parse "primary_key" token:</font></td></tr>
<tr><td align="left"><font face="Monaco">primary_key = <font color="#0550ae">true</font>;      <font color="#6e7781">// matched!</font></font></td></tr>
</table>
    >, style=filled, fillcolor="#e8f0e8"];

    // Final constructed value
    final_value [label=<
<table border="0" cellspacing="0" cellpadding="2">
<tr><td align="left" bgcolor="#d4edda"><b>7. Final Attribute value</b></td></tr>
<tr><td align="left"><font face="Monaco">::facet_core::<font color="#0550ae">Attribute</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">    ns: <font color="#0550ae">Some</font>(<font color="#0a3069">"orm"</font>),</font></td></tr>
<tr><td align="left"><font face="Monaco">    key: <font color="#0a3069">"column"</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    data: <font color="#cf222e">&amp;</font>::orm::<font color="#0550ae">Column</font> {</font></td></tr>
<tr><td align="left"><font face="Monaco">        primary_key: <font color="#0550ae">true</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">        name: <font color="#0550ae">None</font>,</font></td></tr>
<tr><td align="left"><font face="Monaco">    },</font></td></tr>
<tr><td align="left"><font face="Monaco">    shape: &lt;::orm::<font color="#0550ae">Column</font>&gt;::SHAPE,</font></td></tr>
<tr><td align="left"><font face="Monaco">}</font></td></tr>
</table>
    >, style=filled, fillcolor="#e8f5e9"];

    // Edges with descriptions
    user_code -> derive_parse [label="proc-macro\nparses", color="#666"];
    derive_parse -> gen_call [label="emits", color="#228b22", penwidth=2];
    gen_call -> parse_attr_def [label="macro\nexpansion", color="#666"];
    parse_attr_def -> dispatch_match [label="forwards\nwith variants", color="#666"];
    dispatch_match -> build_struct [label="struct variant\nmatched", color="#228b22", penwidth=2];
    build_struct -> final_value [label="constructs", color="#228b22", penwidth=2];
}
