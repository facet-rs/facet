<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extension Attributes Design v3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --bg: light-dark(#fff, #1a1a1a);
      --fg: light-dark(#222, #e8e8e8);
      --fg-muted: light-dark(#666, #999);
      --border: light-dark(#ddd, #444);
      --code-bg: light-dark(#f5f5f5, #2a2a2a);
      --accent: light-dark(#0066cc, #66b3ff);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Public Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      margin: 0;
      padding: 3rem 2rem;
    }

    main {
      max-width: 920px;
      margin: 0 auto;
      padding: 2rem 3rem;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    h2 {
      font-size: 1.75rem;
      margin-top: 3rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }

    h3 {
      font-size: 1.25rem;
      margin-top: 2rem;
    }

    p {
      margin: 1.25rem 0;
    }

    code {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 0.9em;
      background: var(--code-bg);
      padding: 0.15em 0.4em;
      border-radius: 4px;
    }

    pre {
      background: var(--code-bg);
      padding: 1.5rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1.5rem 0;
    }

    pre code {
      background: none;
      padding: 0;
    }

    a {
      color: var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
    }

    th, td {
      text-align: left;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
    }

    th {
      background: var(--code-bg);
      font-weight: 600;
    }

    .diagram {
      padding: 1.5rem;
      background: var(--code-bg);
      border-radius: 8px;
      overflow-x: auto;
      /* Break out of the 920px container */
      width: 90vw;
      max-width: 1850px;
      margin: 2rem auto;
      position: relative;
      left: 50%;
      transform: translateX(-50%);
    }

    .diagram svg,
    .diagram object {
      display: block;
      margin: 0 auto;
      height: auto;
    }

    .diagram-caption {
      text-align: center;
      color: var(--fg-muted);
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 3rem 0;
    }

    .status-done { color: #22c55e; }
    .status-pending { color: #ef4444; }
  </style>
</head>
<body>
  <main>
    <h1>Extension Attributes Design v3</h1>
    <p><em>This document supersedes v1 and v2. It consolidates learnings from the proto-attr prototype into the final design for facet's attribute system.</em></p>

    <hr>

    <h2>Overview</h2>
    <p>Extension attributes allow crates like <code>facet-kdl</code>, <code>facet-args</code>, and <code>facet-yaml</code> to define custom attributes that users apply via <code>#[facet(ns::attr)]</code> syntax.</p>
    <p><strong>Key insight</strong>: Instead of hand-writing parsers in each extension crate, we compile a <strong>grammar DSL</strong> into type-safe parsing infrastructure.</p>

<pre><code>// Extension crate defines grammar once:
facet::define_attr_grammar! {
    pub enum Attr {
        Child,
        Property,
        Column(Column),
    }

    pub struct Column {
        pub name: Option&lt;&apos;static str&gt;,
        pub primary_key: bool,
    }
}

// User writes attributes naturally:
#[derive(Facet)]
struct User {
    #[facet(orm::column(name = "user_id", primary_key))]
    id: i64,
}

// Typos get helpful errors:
// error: unknown attribute `colum`, did you mean `column`?</code></pre>

    <hr>

    <h2>Architecture</h2>

    <h3>Crate Responsibilities</h3>
    <p>Which crate does what:</p>
    <div class="diagram">
      <svg width="887pt" height="1010pt"
 viewBox="0.00 0.00 887.00 1010.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1006)">
<title>crate_responsibilities</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1006 883,-1006 883,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="439.5" y="-979" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">Crate Responsibilities</text>
<g id="clust1" class="cluster">
<title>cluster_legend</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-880.75 8,-961.75 531,-961.75 531,-880.75 8,-880.75"/>
<text xml:space="preserve" text-anchor="middle" x="269.5" y="-938.75" font-family="Helvetica,sans-Serif" font-size="20.00">Legend</text>
</g>
<g id="node1" class="node">
<title>legend_runtime</title>
<polygon fill="#e8f4e8" stroke="black" points="95.5,-924.75 16.5,-924.75 16.5,-888.75 95.5,-888.75 95.5,-924.75"/>
<text xml:space="preserve" text-anchor="middle" x="56" y="-902.3" font-family="Helvetica,sans-Serif" font-size="11.00">runtime crate</text>
</g>
<g id="node2" class="node">
<title>legend_impl</title>
<polygon fill="#f4f4e8" stroke="black" points="220.88,-924.75 153.12,-924.75 153.12,-888.75 220.88,-888.75 220.88,-924.75"/>
<text xml:space="preserve" text-anchor="middle" x="187" y="-902.3" font-family="Helvetica,sans-Serif" font-size="11.00">impl library</text>
</g>
<g id="node3" class="node">
<title>legend_procmacro</title>
<polygon fill="#e8e8f4" stroke="black" points="376.88,-924.75 279.12,-924.75 279.12,-888.75 376.88,-888.75 376.88,-924.75"/>
<text xml:space="preserve" text-anchor="middle" x="328" y="-902.3" font-family="Helvetica,sans-Serif" font-size="11.00">proc&#45;macro crate</text>
</g>
<g id="node4" class="node">
<title>legend_extension</title>
<polygon fill="#f4e8e8" stroke="black" points="523.38,-924.75 434.62,-924.75 434.62,-888.75 523.38,-888.75 523.38,-924.75"/>
<text xml:space="preserve" text-anchor="middle" x="479" y="-902.3" font-family="Helvetica,sans-Serif" font-size="11.00">extension crate</text>
</g>
<g id="node5" class="node">
<title>core</title>
<polygon fill="#e8f4e8" stroke="black" points="879,-973 581,-973 581,-840.5 879,-840.5 879,-973"/>
<text xml:space="preserve" text-anchor="start" x="595" y="-953.55" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="11.00">facet&#45;core</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-928.55" font-family="Helvetica,sans-Serif" font-size="11.00">────────────────────────</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-905.5" font-family="Monaco" font-size="10.00">Shape, Field, ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-880" font-family="Monaco" font-size="10.00">FieldFlags, ShapeAttribute</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-854.5" font-family="Monaco" font-size="10.00">Facet trait</text>
</g>
<g id="node6" class="node">
<title>macros_impl</title>
<polygon fill="#f4f4e8" stroke="black" points="879,-768.5 581,-768.5 581,-585 879,-585 879,-768.5"/>
<text xml:space="preserve" text-anchor="start" x="595" y="-749.05" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="11.00">facet&#45;macros&#45;impl</text>
<text xml:space="preserve" text-anchor="start" x="689.5" y="-749.05" font-family="Helvetica,sans-Serif" font-size="11.00"> (library)</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-724.05" font-family="Helvetica,sans-Serif" font-size="11.00">────────────────────────</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-701.05" font-family="Monaco" font-size="10.00">__make_parse_attr!</text>
<text xml:space="preserve" text-anchor="start" x="703" y="-701.05" font-family="Helvetica,sans-Serif" font-size="11.00"> grammar compiler</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-675.55" font-family="Monaco" font-size="10.00">__dispatch_attr!</text>
<text xml:space="preserve" text-anchor="start" x="691" y="-675.55" font-family="Helvetica,sans-Serif" font-size="11.00"> variant router</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-650.05" font-family="Monaco" font-size="10.00">__build_struct_fields!</text>
<text xml:space="preserve" text-anchor="start" x="727" y="-650.05" font-family="Helvetica,sans-Serif" font-size="11.00"> field parser</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-624.55" font-family="Monaco" font-size="10.00">__attr_error!</text>
<text xml:space="preserve" text-anchor="start" x="673" y="-624.55" font-family="Helvetica,sans-Serif" font-size="11.00"> typo suggestions</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-599.05" font-family="Monaco" font-size="10.00">__field_error!</text>
<text xml:space="preserve" text-anchor="start" x="679" y="-599.05" font-family="Helvetica,sans-Serif" font-size="11.00"> field typo suggestions</text>
</g>
<g id="node7" class="node">
<title>macros</title>
<polygon fill="#e8e8f4" stroke="black" points="879,-513 581,-513 581,-382 879,-382 879,-513"/>
<text xml:space="preserve" text-anchor="start" x="595" y="-493.55" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="11.00">facet&#45;macros</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-468.55" font-family="Helvetica,sans-Serif" font-size="11.00">────────────────────────</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-445.5" font-family="Monaco" font-size="10.00">#[derive(Facet)]</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-419.05" font-family="Helvetica,sans-Serif" font-size="11.00">Extracts ns::attr, generates</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-396.05" font-family="Monaco" font-size="10.00">ns::__parse_attr!(...)</text>
<text xml:space="preserve" text-anchor="start" x="727" y="-396.05" font-family="Helvetica,sans-Serif" font-size="11.00"> calls</text>
</g>
<g id="node8" class="node">
<title>facet</title>
<polygon fill="#e8f4e8" stroke="black" points="879,-310 581,-310 581,-204.5 879,-204.5 879,-310"/>
<text xml:space="preserve" text-anchor="start" x="595" y="-290.55" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="11.00">facet</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-265.55" font-family="Helvetica,sans-Serif" font-size="11.00">────────────────────────</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-241.55" font-family="Helvetica,sans-Serif" font-size="11.00">Re&#45;exports everything</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-218.55" font-family="Monaco" font-size="10.00">define_attr_grammar!</text>
<text xml:space="preserve" text-anchor="start" x="715" y="-218.55" font-family="Helvetica,sans-Serif" font-size="11.00"> public API</text>
</g>
<g id="node9" class="node">
<title>ext</title>
<polygon fill="#f4e8e8" stroke="black" points="879,-132.5 581,-132.5 581,0 879,0 879,-132.5"/>
<text xml:space="preserve" text-anchor="start" x="595" y="-113.05" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="11.00">facet&#45;kdl</text>
<text xml:space="preserve" text-anchor="start" x="640" y="-113.05" font-family="Helvetica,sans-Serif" font-size="11.00"> (example extension)</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-88.05" font-family="Helvetica,sans-Serif" font-size="11.00">────────────────────────</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-65.05" font-family="Helvetica,sans-Serif" font-size="11.00">Calls </text>
<text xml:space="preserve" text-anchor="start" x="622" y="-65.05" font-family="Monaco" font-size="10.00">define_attr_grammar!</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-39.55" font-family="Helvetica,sans-Serif" font-size="11.00">Gets generated </text>
<text xml:space="preserve" text-anchor="start" x="672.25" y="-39.55" font-family="Monaco" font-size="10.00">__parse_attr!</text>
<text xml:space="preserve" text-anchor="start" x="595" y="-14.05" font-family="Helvetica,sans-Serif" font-size="11.00">Gets generated </text>
<text xml:space="preserve" text-anchor="start" x="672.25" y="-14.05" font-family="Monaco" font-size="10.00">Attr</text>
<text xml:space="preserve" text-anchor="start" x="696.25" y="-14.05" font-family="Helvetica,sans-Serif" font-size="11.00"> enum</text>
</g>
</g>
</svg>
      <p class="diagram-caption">Each crate has a specific role in the attribute system</p>
    </div>

    <h3>Dependency Graph</h3>
    <p>How crates depend on each other:</p>
    <div class="diagram">
      <svg width="725pt" height="637pt"
 viewBox="0.00 0.00 725.00 637.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 632.75)">
<title>dependency_graph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-632.75 720.75,-632.75 720.75,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="358.38" y="-605.75" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">Crate Dependency Graph</text>
<g id="clust1" class="cluster">
<title>cluster_legend</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-8 8,-192.75 314,-192.75 314,-8 8,-8"/>
<text xml:space="preserve" text-anchor="middle" x="161" y="-14" font-family="Helvetica,sans-Serif" font-size="20.00">Legend</text>
</g>
<g id="node1" class="node">
<title>l1</title>
<polygon fill="none" stroke="black" points="77,-81 41,-81 41,-45 77,-45 77,-81"/>
<text xml:space="preserve" text-anchor="middle" x="59" y="-58.55" font-family="Helvetica,sans-Serif" font-size="11.00">A</text>
</g>
<g id="node2" class="node">
<title>l2</title>
<polygon fill="none" stroke="black" points="77,-184.75 41,-184.75 41,-148.75 77,-148.75 77,-184.75"/>
<text xml:space="preserve" text-anchor="middle" x="59" y="-162.3" font-family="Helvetica,sans-Serif" font-size="11.00">B</text>
</g>
<g id="edge1" class="edge">
<title>l1&#45;&gt;l2</title>
<path fill="none" stroke="#228b22" d="M56.54,-81.43C55.45,-90.02 54.29,-100.53 53.75,-110 53.24,-118.94 53.78,-128.67 54.68,-137.46"/>
<polygon fill="#228b22" stroke="#228b22" points="51.18,-137.69 55.87,-147.19 58.13,-136.84 51.18,-137.69"/>
<text xml:space="preserve" text-anchor="middle" x="86.38" y="-111.2" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">A depends on B</text>
</g>
<g id="node3" class="node">
<title>l3</title>
<polygon fill="none" stroke="black" points="190,-81 154,-81 154,-45 190,-45 190,-81"/>
<text xml:space="preserve" text-anchor="middle" x="172" y="-58.55" font-family="Helvetica,sans-Serif" font-size="11.00">C</text>
</g>
<g id="node4" class="node">
<title>l4</title>
<polygon fill="none" stroke="black" points="190,-184.75 154,-184.75 154,-148.75 190,-148.75 190,-184.75"/>
<text xml:space="preserve" text-anchor="middle" x="172" y="-162.3" font-family="Helvetica,sans-Serif" font-size="11.00">D</text>
</g>
<g id="edge2" class="edge">
<title>l3&#45;&gt;l4</title>
<path fill="none" stroke="#4169e1" stroke-dasharray="5,2" d="M169.48,-81.06C168.13,-92.09 166.87,-106.75 167.5,-119.75 167.77,-125.37 168.24,-131.35 168.76,-137.09"/>
<polygon fill="#4169e1" stroke="#4169e1" points="165.25,-137.2 169.74,-146.8 172.22,-136.5 165.25,-137.2"/>
<text xml:space="preserve" text-anchor="middle" x="190.75" y="-111.2" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#4169e1">proc&#45;macro</text>
</g>
<g id="node5" class="node">
<title>l5</title>
<polygon fill="none" stroke="black" points="285,-81 249,-81 249,-45 285,-45 285,-81"/>
<text xml:space="preserve" text-anchor="middle" x="267" y="-58.55" font-family="Helvetica,sans-Serif" font-size="11.00">E</text>
</g>
<g id="node6" class="node">
<title>l6</title>
<polygon fill="none" stroke="black" points="285,-184.75 249,-184.75 249,-148.75 285,-148.75 285,-184.75"/>
<text xml:space="preserve" text-anchor="middle" x="267" y="-162.3" font-family="Helvetica,sans-Serif" font-size="11.00">F</text>
</g>
<g id="edge3" class="edge">
<title>l5&#45;&gt;l6</title>
<path fill="none" stroke="#b8860b" stroke-dasharray="1,5" d="M267,-81.26C267,-96.54 267,-119.13 267,-137.11"/>
<polygon fill="#b8860b" stroke="#b8860b" points="263.5,-136.89 267,-146.89 270.5,-136.89 263.5,-136.89"/>
<text xml:space="preserve" text-anchor="middle" x="286.5" y="-111.2" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#b8860b">build&#45;dep</text>
</g>
<g id="node7" class="node">
<title>core</title>
<polygon fill="none" stroke="black" points="562,-599.75 498,-599.75 498,-563.75 562,-563.75 562,-599.75"/>
<text xml:space="preserve" text-anchor="middle" x="530" y="-577.3" font-family="Helvetica,sans-Serif" font-size="11.00">facet&#45;core</text>
</g>
<g id="node8" class="node">
<title>macros_impl</title>
<polygon fill="none" stroke="black" points="661.75,-496 560.25,-496 560.25,-460 661.75,-460 661.75,-496"/>
<text xml:space="preserve" text-anchor="middle" x="611" y="-479.55" font-family="Helvetica,sans-Serif" font-size="11.00">facet&#45;macros&#45;impl</text>
<text xml:space="preserve" text-anchor="middle" x="611" y="-467.55" font-family="Helvetica,sans-Serif" font-size="11.00">(impl library)</text>
</g>
<g id="edge5" class="edge">
<title>macros_impl&#45;&gt;core</title>
<path fill="none" stroke="#4169e1" stroke-dasharray="5,2" d="M597.26,-496.26C584.58,-512.19 565.55,-536.09 550.97,-554.41"/>
<polygon fill="#4169e1" stroke="#4169e1" points="548.24,-552.22 544.75,-562.22 553.72,-556.58 548.24,-552.22"/>
<text xml:space="preserve" text-anchor="middle" x="586.8" y="-526.2" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#4169e1">(types)</text>
</g>
<g id="node9" class="node">
<title>macros</title>
<polygon fill="none" stroke="black" points="644.12,-392.25 565.88,-392.25 565.88,-356.25 644.12,-356.25 644.12,-392.25"/>
<text xml:space="preserve" text-anchor="middle" x="605" y="-375.8" font-family="Helvetica,sans-Serif" font-size="11.00">facet&#45;macros</text>
<text xml:space="preserve" text-anchor="middle" x="605" y="-363.8" font-family="Helvetica,sans-Serif" font-size="11.00">(proc&#45;macro)</text>
</g>
<g id="edge6" class="edge">
<title>macros&#45;&gt;macros_impl</title>
<path fill="none" stroke="#4169e1" stroke-dasharray="5,2" d="M606.02,-392.51C606.92,-407.79 608.25,-430.38 609.31,-448.36"/>
<polygon fill="#4169e1" stroke="#4169e1" points="605.81,-448.37 609.89,-458.14 612.79,-447.96 605.81,-448.37"/>
<text xml:space="preserve" text-anchor="middle" x="620.93" y="-422.45" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#4169e1">(logic)</text>
</g>
<g id="node10" class="node">
<title>facet</title>
<polygon fill="none" stroke="black" points="557,-288.5 503,-288.5 503,-252.5 557,-252.5 557,-288.5"/>
<text xml:space="preserve" text-anchor="middle" x="530" y="-266.05" font-family="Helvetica,sans-Serif" font-size="11.00">facet</text>
</g>
<g id="edge4" class="edge">
<title>facet&#45;&gt;core</title>
<path fill="none" stroke="#228b22" d="M530,-288.57C530,-339.14 530,-488.59 530,-551.9"/>
<polygon fill="#228b22" stroke="#228b22" points="526.5,-551.84 530,-561.84 533.5,-551.84 526.5,-551.84"/>
<text xml:space="preserve" text-anchor="middle" x="545.38" y="-422.45" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
<g id="edge7" class="edge">
<title>facet&#45;&gt;macros</title>
<path fill="none" stroke="#4169e1" stroke-dasharray="5,2" d="M542.72,-288.76C554.41,-304.62 571.92,-328.37 585.4,-346.65"/>
<polygon fill="#4169e1" stroke="#4169e1" points="582.57,-348.71 591.32,-354.69 588.2,-344.56 582.57,-348.71"/>
<text xml:space="preserve" text-anchor="middle" x="593" y="-318.7" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#4169e1">proc&#45;macro</text>
</g>
<g id="node11" class="node">
<title>kdl</title>
<polygon fill="none" stroke="black" points="501.25,-184.75 444.75,-184.75 444.75,-148.75 501.25,-148.75 501.25,-184.75"/>
<text xml:space="preserve" text-anchor="middle" x="473" y="-162.3" font-family="Helvetica,sans-Serif" font-size="11.00">facet&#45;kdl</text>
</g>
<g id="edge8" class="edge">
<title>kdl&#45;&gt;facet</title>
<path fill="none" stroke="#228b22" d="M482.67,-185.01C491.43,-200.65 504.49,-223.96 514.67,-242.14"/>
<polygon fill="#228b22" stroke="#228b22" points="511.6,-243.82 519.54,-250.83 517.71,-240.4 511.6,-243.82"/>
<text xml:space="preserve" text-anchor="middle" x="518.58" y="-214.95" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
<g id="node12" class="node">
<title>args</title>
<polygon fill="none" stroke="black" points="608,-184.75 544,-184.75 544,-148.75 608,-148.75 608,-184.75"/>
<text xml:space="preserve" text-anchor="middle" x="576" y="-162.3" font-family="Helvetica,sans-Serif" font-size="11.00">facet&#45;args</text>
</g>
<g id="edge9" class="edge">
<title>args&#45;&gt;facet</title>
<path fill="none" stroke="#228b22" d="M568.2,-185.01C561.16,-200.58 550.68,-223.75 542.48,-241.89"/>
<polygon fill="#228b22" stroke="#228b22" points="539.4,-240.22 538.47,-250.78 545.77,-243.11 539.4,-240.22"/>
<text xml:space="preserve" text-anchor="middle" x="569.75" y="-214.95" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
<g id="node13" class="node">
<title>yaml</title>
<polygon fill="none" stroke="black" points="716.75,-184.75 651.25,-184.75 651.25,-148.75 716.75,-148.75 716.75,-184.75"/>
<text xml:space="preserve" text-anchor="middle" x="684" y="-162.3" font-family="Helvetica,sans-Serif" font-size="11.00">facet&#45;yaml</text>
</g>
<g id="edge10" class="edge">
<title>yaml&#45;&gt;facet</title>
<path fill="none" stroke="#228b22" d="M657.53,-185.24C632.22,-201.96 593.87,-227.3 565.83,-245.82"/>
<polygon fill="#228b22" stroke="#228b22" points="564.06,-242.8 557.65,-251.23 567.92,-248.64 564.06,-242.8"/>
<text xml:space="preserve" text-anchor="middle" x="626.99" y="-214.95" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
<g id="node14" class="node">
<title>user</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="505,-81 441,-81 441,-45 505,-45 505,-81"/>
<text xml:space="preserve" text-anchor="middle" x="473" y="-58.55" font-family="Helvetica,sans-Serif" font-size="11.00">user crate</text>
</g>
<g id="edge11" class="edge">
<title>user&#45;&gt;facet</title>
<path fill="none" stroke="#228b22" d="M448.45,-81.3C416.79,-105.83 368.46,-152.26 392.25,-192.75 413.62,-229.12 459.17,-249.51 492.05,-259.98"/>
<polygon fill="#228b22" stroke="#228b22" points="490.62,-263.21 501.21,-262.73 492.63,-256.51 490.62,-263.21"/>
<text xml:space="preserve" text-anchor="middle" x="407.62" y="-163.07" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
<g id="edge12" class="edge">
<title>user&#45;&gt;kdl</title>
<path fill="none" stroke="#228b22" d="M473,-81.26C473,-96.54 473,-119.13 473,-137.11"/>
<polygon fill="#228b22" stroke="#228b22" points="469.5,-136.89 473,-146.89 476.5,-136.89 469.5,-136.89"/>
<text xml:space="preserve" text-anchor="middle" x="488.38" y="-111.2" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
<g id="edge13" class="edge">
<title>user&#45;&gt;args</title>
<path fill="none" stroke="#228b22" d="M490.47,-81.26C506.9,-97.49 531.68,-121.97 550.35,-140.41"/>
<polygon fill="#228b22" stroke="#228b22" points="547.79,-142.8 557.36,-147.34 552.71,-137.82 547.79,-142.8"/>
<text xml:space="preserve" text-anchor="middle" x="542.96" y="-111.2" font-family="Helvetica,sans-Serif" font-size="9.00" fill="#228b22">runtime</text>
</g>
</g>
</svg>
      <p class="diagram-caption">Green = runtime dep, Blue dashed = proc-macro dep</p>
    </div>

    <h3>1. Grammar Definition Time</h3>
    <p>What <code>::facet::define_attr_grammar!</code> generates:</p>
    <div class="diagram">
      <svg width="1276pt" height="392pt"
 viewBox="0.00 0.00 1276.00 392.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 387.75)">
<title>grammar_definition</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-387.75 1271.75,-387.75 1271.75,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="633.88" y="-360.75" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">Grammar Definition Time</text>
<g id="node1" class="node">
<title>grammar</title>
<polygon fill="#fff8f0" stroke="black" points="290,-290.88 0,-290.88 0,-63.88 290,-63.88 290,-290.88"/>
<polygon fill="#ffe4c4" stroke="none" points="8,-268.62 8,-286.88 282,-286.88 282,-268.62 8,-268.62"/>
<text xml:space="preserve" text-anchor="start" x="10" y="-275.43" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Input: facet&#45;kdl/src/lib.rs</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-257.18" font-family="Monaco" font-size="11.00">::facet::</text>
<text xml:space="preserve" text-anchor="start" x="70.75" y="-257.18" font-family="Monaco" font-size="11.00" fill="#8250df">define_attr_grammar!</text>
<text xml:space="preserve" text-anchor="start" x="205.75" y="-257.18" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-238.93" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-238.93" font-family="Monaco" font-size="11.00" fill="#cf222e">pub enum</text>
<text xml:space="preserve" text-anchor="start" x="91" y="-238.93" font-family="Monaco" font-size="11.00"> </text>
<text xml:space="preserve" text-anchor="start" x="97.75" y="-238.93" font-family="Monaco" font-size="11.00" fill="#0550ae">Attr</text>
<text xml:space="preserve" text-anchor="start" x="124.75" y="-238.93" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-220.68" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;Child, &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="212.5" y="-220.68" font-family="Monaco" font-size="11.00" fill="#6e7781">// unit</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-202.43" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;Rename(</text>
<text xml:space="preserve" text-anchor="start" x="111.25" y="-202.43" font-family="Monaco" font-size="11.00" fill="#0550ae">&amp;&#39;static str</text>
<text xml:space="preserve" text-anchor="start" x="192.25" y="-202.43" font-family="Monaco" font-size="11.00">), </text>
<text xml:space="preserve" text-anchor="start" x="212.5" y="-202.43" font-family="Monaco" font-size="11.00" fill="#6e7781">// newtype</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-184.18" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;Column(</text>
<text xml:space="preserve" text-anchor="start" x="111.25" y="-184.18" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="151.75" y="-184.18" font-family="Monaco" font-size="11.00">), &#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="212.5" y="-184.18" font-family="Monaco" font-size="11.00" fill="#6e7781">// struct</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-164.93" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-147.68" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-147.68" font-family="Monaco" font-size="11.00" fill="#cf222e">pub struct</text>
<text xml:space="preserve" text-anchor="start" x="104.5" y="-147.68" font-family="Monaco" font-size="11.00"> </text>
<text xml:space="preserve" text-anchor="start" x="111.25" y="-147.68" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="151.75" y="-147.68" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-129.43" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-129.43" font-family="Monaco" font-size="11.00" fill="#cf222e">pub</text>
<text xml:space="preserve" text-anchor="start" x="84.25" y="-129.43" font-family="Monaco" font-size="11.00"> primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="178.75" y="-129.43" font-family="Monaco" font-size="11.00" fill="#0550ae">bool</text>
<text xml:space="preserve" text-anchor="start" x="205.75" y="-129.43" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-111.17" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-111.17" font-family="Monaco" font-size="11.00" fill="#cf222e">pub</text>
<text xml:space="preserve" text-anchor="start" x="84.25" y="-111.17" font-family="Monaco" font-size="11.00"> name: </text>
<text xml:space="preserve" text-anchor="start" x="131.5" y="-111.17" font-family="Monaco" font-size="11.00" fill="#0550ae">Option</text>
<text xml:space="preserve" text-anchor="start" x="172" y="-111.17" font-family="Monaco" font-size="11.00">&lt;</text>
<text xml:space="preserve" text-anchor="start" x="178.75" y="-111.17" font-family="Monaco" font-size="11.00" fill="#0550ae">&amp;&#39;static str</text>
<text xml:space="preserve" text-anchor="start" x="259.75" y="-111.17" font-family="Monaco" font-size="11.00">&gt;,</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-91.92" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-73.67" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="node2" class="node">
<title>make_parse</title>
<polygon fill="#e8e8f4" stroke="black" points="633,-208.75 430.75,-208.75 430.75,-146 633,-146 633,-208.75"/>
<polygon fill="#e8e8f4" stroke="none" points="438.75,-186.5 438.75,-204.75 625,-204.75 625,-186.5 438.75,-186.5"/>
<text xml:space="preserve" text-anchor="start" x="474.5" y="-193.3" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">facet&#45;macros&#45;impl</text>
<text xml:space="preserve" text-anchor="start" x="440.75" y="-175.05" font-family="Monaco" font-size="11.00">::facet::</text>
<text xml:space="preserve" text-anchor="start" x="501.5" y="-175.05" font-family="Monaco" font-size="11.00" fill="#8250df">__make_parse_attr!</text>
<text xml:space="preserve" text-anchor="start" x="471.12" y="-155.8" font-family="Monaco, Consolas, Courier" font-size="11.00">(grammar compiler)</text>
</g>
<g id="edge1" class="edge">
<title>grammar&#45;&gt;make_parse</title>
<path fill="none" stroke="#4169e1" stroke-width="2" d="M290.41,-177.38C332.37,-177.38 377.59,-177.38 417.37,-177.38"/>
<polygon fill="#4169e1" stroke="#4169e1" stroke-width="2" points="417.33,-180.88 427.33,-177.38 417.33,-173.88 417.33,-180.88"/>
<text xml:space="preserve" text-anchor="middle" x="360.38" y="-179.12" font-family="Helvetica,sans-Serif" font-size="10.00">compiles via</text>
</g>
<g id="node3" class="node">
<title>generated</title>
<polygon fill="#f0fff0" stroke="black" points="1267.75,-354.75 761.75,-354.75 761.75,0 1267.75,0 1267.75,-354.75"/>
<polygon fill="#d4edda" stroke="none" points="769.75,-332.5 769.75,-350.75 1259.75,-350.75 1259.75,-332.5 769.75,-332.5"/>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-339.3" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Generated in facet&#45;kdl</text>
<polygon fill="#e8f5e9" stroke="none" points="769.75,-314.25 769.75,-332.5 1259.75,-332.5 1259.75,-314.25 769.75,-314.25"/>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-321.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">1. Runtime types</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-302.8" font-family="Monaco" font-size="11.00" fill="#cf222e">pub enum</text>
<text xml:space="preserve" text-anchor="start" x="825.75" y="-302.8" font-family="Monaco" font-size="11.00"> </text>
<text xml:space="preserve" text-anchor="start" x="832.5" y="-302.8" font-family="Monaco" font-size="11.00" fill="#0550ae">Attr</text>
<text xml:space="preserve" text-anchor="start" x="859.5" y="-302.8" font-family="Monaco" font-size="11.00"> { Child, Rename(</text>
<text xml:space="preserve" text-anchor="start" x="974.25" y="-302.8" font-family="Monaco" font-size="11.00" fill="#0550ae">...</text>
<text xml:space="preserve" text-anchor="start" x="994.5" y="-302.8" font-family="Monaco" font-size="11.00">), Column(</text>
<text xml:space="preserve" text-anchor="start" x="1062" y="-302.8" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="1102.5" y="-302.8" font-family="Monaco" font-size="11.00">) }</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-284.55" font-family="Monaco" font-size="11.00" fill="#cf222e">pub struct</text>
<text xml:space="preserve" text-anchor="start" x="839.25" y="-284.55" font-family="Monaco" font-size="11.00"> </text>
<text xml:space="preserve" text-anchor="start" x="846" y="-284.55" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="886.5" y="-284.55" font-family="Monaco" font-size="11.00"> { primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="994.5" y="-284.55" font-family="Monaco" font-size="11.00" fill="#0550ae">bool</text>
<text xml:space="preserve" text-anchor="start" x="1021.5" y="-284.55" font-family="Monaco" font-size="11.00">, name: </text>
<text xml:space="preserve" text-anchor="start" x="1075.5" y="-284.55" font-family="Monaco" font-size="11.00" fill="#0550ae">Option</text>
<text xml:space="preserve" text-anchor="start" x="1116" y="-284.55" font-family="Monaco" font-size="11.00">&lt;...&gt; }</text>
<polygon fill="#fff3cd" stroke="none" points="769.75,-259.5 769.75,-277.75 1259.75,-277.75 1259.75,-259.5 769.75,-259.5"/>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-266.3" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">2. THE COMPILED GRAMMAR (declarative macro)</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-248.05" font-family="Monaco" font-size="11.00" fill="#cf222e">macro_rules!</text>
<text xml:space="preserve" text-anchor="start" x="852.75" y="-248.05" font-family="Monaco" font-size="11.00"> </text>
<text xml:space="preserve" text-anchor="start" x="859.5" y="-248.05" font-family="Monaco" font-size="11.00" fill="#8250df">__parse_attr</text>
<text xml:space="preserve" text-anchor="start" x="940.5" y="-248.05" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-229.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;(child) =&gt; { </text>
<text xml:space="preserve" text-anchor="start" x="886.5" y="-229.8" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="974.25" y="-229.8" font-family="Monaco" font-size="11.00"> { ns:</text>
<text xml:space="preserve" text-anchor="start" x="1014.75" y="-229.8" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;kdl&quot;</text>
<text xml:space="preserve" text-anchor="start" x="1048.5" y="-229.8" font-family="Monaco" font-size="11.00">, key:</text>
<text xml:space="preserve" text-anchor="start" x="1089" y="-229.8" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;child&quot;</text>
<text xml:space="preserve" text-anchor="start" x="1136.25" y="-229.8" font-family="Monaco" font-size="11.00">, data:</text>
<text xml:space="preserve" text-anchor="start" x="1183.5" y="-229.8" font-family="Monaco" font-size="11.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="1190.25" y="-229.8" font-family="Monaco" font-size="11.00">() } };</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-211.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;(rename = </text>
<text xml:space="preserve" text-anchor="start" x="866.25" y="-211.55" font-family="Monaco" font-size="11.00" fill="#953800">$v</text>
<text xml:space="preserve" text-anchor="start" x="879.75" y="-211.55" font-family="Monaco" font-size="11.00">:literal) =&gt; { </text>
<text xml:space="preserve" text-anchor="start" x="981" y="-211.55" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="1068.75" y="-211.55" font-family="Monaco" font-size="11.00"> { ... data:</text>
<text xml:space="preserve" text-anchor="start" x="1149.75" y="-211.55" font-family="Monaco" font-size="11.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="1156.5" y="-211.55" font-family="Monaco" font-size="11.00" fill="#953800">$v</text>
<text xml:space="preserve" text-anchor="start" x="1170" y="-211.55" font-family="Monaco" font-size="11.00"> } };</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-193.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;(column($(</text>
<text xml:space="preserve" text-anchor="start" x="866.25" y="-193.3" font-family="Monaco" font-size="11.00" fill="#953800">$f</text>
<text xml:space="preserve" text-anchor="start" x="879.75" y="-193.3" font-family="Monaco" font-size="11.00">:tt)*)) =&gt; {</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-175.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="825.75" y="-175.05" font-family="Monaco" font-size="11.00" fill="#953800">$crate</text>
<text xml:space="preserve" text-anchor="start" x="866.25" y="-175.05" font-family="Monaco" font-size="11.00">::</text>
<text xml:space="preserve" text-anchor="start" x="879.75" y="-175.05" font-family="Monaco" font-size="11.00" fill="#8250df">__dispatch_attr!</text>
<text xml:space="preserve" text-anchor="start" x="987.75" y="-175.05" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-156.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="852.75" y="-156.8" font-family="Monaco" font-size="11.00" fill="#8250df">@struct</text>
<text xml:space="preserve" text-anchor="start" x="900" y="-156.8" font-family="Monaco" font-size="11.00"> { </text>
<text xml:space="preserve" text-anchor="start" x="920.25" y="-156.8" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="960.75" y="-156.8" font-family="Monaco" font-size="11.00"> }</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-138.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="852.75" y="-138.55" font-family="Monaco" font-size="11.00" fill="#8250df">@schema</text>
<text xml:space="preserve" text-anchor="start" x="900" y="-138.55" font-family="Monaco" font-size="11.00"> { primary_key:</text>
<text xml:space="preserve" text-anchor="start" x="1001.25" y="-138.55" font-family="Monaco" font-size="11.00" fill="#0550ae">bool</text>
<text xml:space="preserve" text-anchor="start" x="1028.25" y="-138.55" font-family="Monaco" font-size="11.00">=</text>
<text xml:space="preserve" text-anchor="start" x="1035" y="-138.55" font-family="Monaco" font-size="11.00" fill="#0550ae">false</text>
<text xml:space="preserve" text-anchor="start" x="1068.75" y="-138.55" font-family="Monaco" font-size="11.00">, name:</text>
<text xml:space="preserve" text-anchor="start" x="1116" y="-138.55" font-family="Monaco" font-size="11.00" fill="#0550ae">opt_str</text>
<text xml:space="preserve" text-anchor="start" x="1163.25" y="-138.55" font-family="Monaco" font-size="11.00">=</text>
<text xml:space="preserve" text-anchor="start" x="1170" y="-138.55" font-family="Monaco" font-size="11.00" fill="#0550ae">None</text>
<text xml:space="preserve" text-anchor="start" x="1197" y="-138.55" font-family="Monaco" font-size="11.00"> }</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-120.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="852.75" y="-120.3" font-family="Monaco" font-size="11.00" fill="#8250df">@input</text>
<text xml:space="preserve" text-anchor="start" x="893.25" y="-120.3" font-family="Monaco" font-size="11.00"> { $(</text>
<text xml:space="preserve" text-anchor="start" x="927" y="-120.3" font-family="Monaco" font-size="11.00" fill="#953800">$f</text>
<text xml:space="preserve" text-anchor="start" x="940.5" y="-120.3" font-family="Monaco" font-size="11.00">)* } &#160;</text>
<text xml:space="preserve" text-anchor="start" x="981" y="-120.3" font-family="Monaco" font-size="11.00" fill="#6e7781">// &lt;&#45;&#45; user&#39;s tokens</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-101.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-82.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;};</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-65.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;(</text>
<text xml:space="preserve" text-anchor="start" x="805.5" y="-65.55" font-family="Monaco" font-size="11.00" fill="#953800">$unk</text>
<text xml:space="preserve" text-anchor="start" x="832.5" y="-65.55" font-family="Monaco" font-size="11.00">:ident $(</text>
<text xml:space="preserve" text-anchor="start" x="893.25" y="-65.55" font-family="Monaco" font-size="11.00" fill="#953800">$r</text>
<text xml:space="preserve" text-anchor="start" x="906.75" y="-65.55" font-family="Monaco" font-size="11.00">:tt)*) =&gt; { </text>
<text xml:space="preserve" text-anchor="start" x="987.75" y="-65.55" font-family="Monaco" font-size="11.00" fill="#8250df">__attr_error!</text>
<text xml:space="preserve" text-anchor="start" x="1075.5" y="-65.55" font-family="Monaco" font-size="11.00">(</text>
<text xml:space="preserve" text-anchor="start" x="1082.25" y="-65.55" font-family="Monaco" font-size="11.00" fill="#8250df">@known</text>
<text xml:space="preserve" text-anchor="start" x="1122.75" y="-65.55" font-family="Monaco" font-size="11.00">{...} </text>
<text xml:space="preserve" text-anchor="start" x="1163.25" y="-65.55" font-family="Monaco" font-size="11.00" fill="#8250df">@got</text>
<text xml:space="preserve" text-anchor="start" x="1190.25" y="-65.55" font-family="Monaco" font-size="11.00">{</text>
<text xml:space="preserve" text-anchor="start" x="1197" y="-65.55" font-family="Monaco" font-size="11.00" fill="#953800">$unk</text>
<text xml:space="preserve" text-anchor="start" x="1224" y="-65.55" font-family="Monaco" font-size="11.00">}) };</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-46.3" font-family="Monaco" font-size="11.00">}</text>
<polygon fill="#e8f5e9" stroke="none" points="769.75,-22.25 769.75,-40.5 1259.75,-40.5 1259.75,-22.25 769.75,-22.25"/>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-29.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">3. Re&#45;exports (macro hygiene)</text>
<text xml:space="preserve" text-anchor="start" x="771.75" y="-10.8" font-family="Monaco" font-size="11.00" fill="#cf222e">pub use</text>
<text xml:space="preserve" text-anchor="start" x="819" y="-10.8" font-family="Monaco" font-size="11.00"> ::facet::{</text>
<text xml:space="preserve" text-anchor="start" x="893.25" y="-10.8" font-family="Monaco" font-size="11.00" fill="#8250df">__dispatch_attr</text>
<text xml:space="preserve" text-anchor="start" x="994.5" y="-10.8" font-family="Monaco" font-size="11.00">, </text>
<text xml:space="preserve" text-anchor="start" x="1008" y="-10.8" font-family="Monaco" font-size="11.00" fill="#8250df">__attr_error</text>
<text xml:space="preserve" text-anchor="start" x="1089" y="-10.8" font-family="Monaco" font-size="11.00">, ...};</text>
</g>
<g id="edge2" class="edge">
<title>make_parse&#45;&gt;generated</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M633.39,-177.38C667.7,-177.38 707.84,-177.38 748.94,-177.38"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="748.69,-180.88 758.69,-177.38 748.69,-173.88 748.69,-180.88"/>
<text xml:space="preserve" text-anchor="middle" x="697.38" y="-179.12" font-family="Helvetica,sans-Serif" font-size="10.00">generates</text>
</g>
</g>
</svg>
      <p class="diagram-caption">The grammar compiler transforms DSL into types + parsing macro + re-exports</p>
    </div>

    <h3>2. Attribute Usage Flow (High Level)</h3>
    <p>What happens when user writes <code>#[facet(orm::column(...))]</code>:</p>
    <div class="diagram">
      <svg width="340pt" height="1369pt"
 viewBox="0.00 0.00 340.00 1369.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1365)">
<title>attribute_usage</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1365 336,-1365 336,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="166" y="-1338" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">Attribute Usage Flow (Detailed)</text>
<g id="node1" class="node">
<title>user_code</title>
<polygon fill="#fff8f0" stroke="black" points="290,-1332 42,-1332 42,-1219 290,-1219 290,-1332"/>
<polygon fill="#fff8f0" stroke="none" points="50,-1310.5 50,-1328 282,-1328 282,-1310.5 50,-1310.5"/>
<text xml:space="preserve" text-anchor="start" x="52" y="-1317.5" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">1. User code</text>
<text xml:space="preserve" text-anchor="start" x="52" y="-1300" font-family="Monaco" font-size="10.00">#[</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-1300" font-family="Monaco" font-size="10.00" fill="#8250df">derive</text>
<text xml:space="preserve" text-anchor="start" x="100" y="-1300" font-family="Monaco" font-size="10.00">(::</text>
<text xml:space="preserve" text-anchor="start" x="118" y="-1300" font-family="Monaco" font-size="10.00" fill="#0550ae">facet</text>
<text xml:space="preserve" text-anchor="start" x="148" y="-1300" font-family="Monaco" font-size="10.00">::</text>
<text xml:space="preserve" text-anchor="start" x="160" y="-1300" font-family="Monaco" font-size="10.00" fill="#0550ae">Facet</text>
<text xml:space="preserve" text-anchor="start" x="190" y="-1300" font-family="Monaco" font-size="10.00">)]</text>
<text xml:space="preserve" text-anchor="start" x="52" y="-1282.5" font-family="Monaco" font-size="10.00" fill="#cf222e">struct</text>
<text xml:space="preserve" text-anchor="start" x="88" y="-1282.5" font-family="Monaco" font-size="10.00"> </text>
<text xml:space="preserve" text-anchor="start" x="94" y="-1282.5" font-family="Monaco" font-size="10.00" fill="#0550ae">User</text>
<text xml:space="preserve" text-anchor="start" x="118" y="-1282.5" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="52" y="-1265" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;#[</text>
<text xml:space="preserve" text-anchor="start" x="88" y="-1265" font-family="Monaco" font-size="10.00" fill="#8250df">facet</text>
<text xml:space="preserve" text-anchor="start" x="118" y="-1265" font-family="Monaco" font-size="10.00">(orm::column(primary_key))]</text>
<text xml:space="preserve" text-anchor="start" x="52" y="-1247.5" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;id: </text>
<text xml:space="preserve" text-anchor="start" x="100" y="-1247.5" font-family="Monaco" font-size="10.00" fill="#0550ae">i64</text>
<text xml:space="preserve" text-anchor="start" x="118" y="-1247.5" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="52" y="-1229" font-family="Monaco" font-size="10.00">}</text>
</g>
<g id="node2" class="node">
<title>derive_parse</title>
<polygon fill="#e8e8f4" stroke="black" points="332,-1163.5 0,-1163.5 0,-1085.5 332,-1085.5 332,-1163.5"/>
<polygon fill="#e8e8f4" stroke="none" points="8,-1142 8,-1159.5 324,-1159.5 324,-1142 8,-1142"/>
<text xml:space="preserve" text-anchor="start" x="10" y="-1149" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">2. facet&#45;macros parses attribute</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-1130.5" font-family="Monaco" font-size="10.00" fill="#6e7781">// Extracts from #[facet(orm::column(primary_key))]:</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-1114" font-family="Monaco" font-size="10.00">namespace = </text>
<text xml:space="preserve" text-anchor="start" x="82" y="-1114" font-family="Monaco" font-size="10.00" fill="#0a3069">&quot;orm&quot;</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-1096.5" font-family="Monaco" font-size="10.00">rest = </text>
<text xml:space="preserve" text-anchor="start" x="52" y="-1096.5" font-family="Monaco" font-size="10.00" fill="#0a3069">column(primary_key)</text>
</g>
<g id="edge1" class="edge">
<title>user_code&#45;&gt;derive_parse</title>
<path fill="none" stroke="#666666" d="M166,-1218.59C166,-1204.27 166,-1188.97 166,-1175"/>
<polygon fill="#666666" stroke="#666666" points="169.5,-1175.14 166,-1165.14 162.5,-1175.14 169.5,-1175.14"/>
<text xml:space="preserve" text-anchor="middle" x="189.25" y="-1192.45" font-family="Helvetica,sans-Serif" font-size="9.00">proc&#45;macro</text>
<text xml:space="preserve" text-anchor="middle" x="189.25" y="-1182.7" font-family="Helvetica,sans-Serif" font-size="9.00">parses</text>
</g>
<g id="node3" class="node">
<title>gen_call</title>
<polygon fill="#fff9e6" stroke="black" points="284,-1039.75 48,-1039.75 48,-944.25 284,-944.25 284,-1039.75"/>
<polygon fill="#fff3cd" stroke="none" points="56,-1018.25 56,-1035.75 276,-1035.75 276,-1018.25 56,-1018.25"/>
<text xml:space="preserve" text-anchor="start" x="58" y="-1025.25" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">3. Generates call to namespace macro</text>
<text xml:space="preserve" text-anchor="start" x="58" y="-1007.75" font-family="Monaco" font-size="10.00">::orm::</text>
<text xml:space="preserve" text-anchor="start" x="100" y="-1007.75" font-family="Monaco" font-size="10.00" fill="#8250df">__parse_attr!</text>
<text xml:space="preserve" text-anchor="start" x="178" y="-1007.75" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="58" y="-990.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="82" y="-990.25" font-family="Monaco" font-size="10.00" fill="#8250df">@input</text>
<text xml:space="preserve" text-anchor="start" x="118" y="-990.25" font-family="Monaco" font-size="10.00"> { column(primary_key) }</text>
<text xml:space="preserve" text-anchor="start" x="58" y="-972.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="82" y="-972.75" font-family="Monaco" font-size="10.00" fill="#8250df">@ns</text>
<text xml:space="preserve" text-anchor="start" x="100" y="-972.75" font-family="Monaco" font-size="10.00"> { </text>
<text xml:space="preserve" text-anchor="start" x="118" y="-972.75" font-family="Monaco" font-size="10.00" fill="#0a3069">&quot;orm&quot;</text>
<text xml:space="preserve" text-anchor="start" x="148" y="-972.75" font-family="Monaco" font-size="10.00"> }</text>
<text xml:space="preserve" text-anchor="start" x="58" y="-954.25" font-family="Monaco" font-size="10.00">}</text>
</g>
<g id="edge2" class="edge">
<title>derive_parse&#45;&gt;gen_call</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M166,-1085.05C166,-1074.89 166,-1063.68 166,-1052.69"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="169.5,-1052.98 166,-1042.98 162.5,-1052.98 169.5,-1052.98"/>
<text xml:space="preserve" text-anchor="middle" x="176.88" y="-1058.95" font-family="Helvetica,sans-Serif" font-size="9.00">emits</text>
</g>
<g id="node4" class="node">
<title>parse_attr_def</title>
<polygon fill="#f4e8e8" stroke="black" points="323,-888.75 9,-888.75 9,-618.25 323,-618.25 323,-888.75"/>
<polygon fill="#f4e8e8" stroke="none" points="17,-867.25 17,-884.75 315,-884.75 315,-867.25 17,-867.25"/>
<text xml:space="preserve" text-anchor="start" x="19" y="-874.25" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">4. orm::__parse_attr! (from define_attr_grammar!)</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-855.75" font-family="Monaco" font-size="10.00" fill="#6e7781">// Generated macro contains variant list:</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-839.25" font-family="Monaco" font-size="10.00" fill="#8250df">macro_rules!</text>
<text xml:space="preserve" text-anchor="start" x="91" y="-839.25" font-family="Monaco" font-size="10.00"> __parse_attr {</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-821.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;($(</text>
<text xml:space="preserve" text-anchor="start" x="61" y="-821.75" font-family="Monaco" font-size="10.00" fill="#cf222e">$</text>
<text xml:space="preserve" text-anchor="start" x="67" y="-821.75" font-family="Monaco" font-size="10.00">input:tt)*) =&gt; {</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-804.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;::</text>
<text xml:space="preserve" text-anchor="start" x="79" y="-804.25" font-family="Monaco" font-size="10.00" fill="#0550ae">facet</text>
<text xml:space="preserve" text-anchor="start" x="109" y="-804.25" font-family="Monaco" font-size="10.00">::</text>
<text xml:space="preserve" text-anchor="start" x="121" y="-804.25" font-family="Monaco" font-size="10.00" fill="#8250df">__dispatch_attr!</text>
<text xml:space="preserve" text-anchor="start" x="217" y="-804.25" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-786.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="91" y="-786.75" font-family="Monaco" font-size="10.00" fill="#8250df">@variants</text>
<text xml:space="preserve" text-anchor="start" x="145" y="-786.75" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-769.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;skip =&gt; </text>
<text xml:space="preserve" text-anchor="start" x="163" y="-769.25" font-family="Monaco" font-size="10.00" fill="#0550ae">unit</text>
<text xml:space="preserve" text-anchor="start" x="187" y="-769.25" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-751.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rename =&gt; </text>
<text xml:space="preserve" text-anchor="start" x="175" y="-751.75" font-family="Monaco" font-size="10.00" fill="#0550ae">newtype</text>
<text xml:space="preserve" text-anchor="start" x="217" y="-751.75" font-family="Monaco" font-size="10.00">(</text>
<text xml:space="preserve" text-anchor="start" x="223" y="-751.75" font-family="Monaco" font-size="10.00" fill="#0550ae">String</text>
<text xml:space="preserve" text-anchor="start" x="259" y="-751.75" font-family="Monaco" font-size="10.00">),</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-734.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;column =&gt; </text>
<text xml:space="preserve" text-anchor="start" x="175" y="-734.25" font-family="Monaco" font-size="10.00" fill="#0550ae">struct</text>
<text xml:space="preserve" text-anchor="start" x="211" y="-734.25" font-family="Monaco" font-size="10.00"> { ... },</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-715.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-699.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="91" y="-699.25" font-family="Monaco" font-size="10.00" fill="#8250df">@input</text>
<text xml:space="preserve" text-anchor="start" x="127" y="-699.25" font-family="Monaco" font-size="10.00"> { $($input)* }</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-680.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;...</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-663.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-645.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="19" y="-628.25" font-family="Monaco" font-size="10.00">}</text>
</g>
<g id="edge3" class="edge">
<title>gen_call&#45;&gt;parse_attr_def</title>
<path fill="none" stroke="#666666" d="M166,-943.99C166,-930.98 166,-916.14 166,-900.62"/>
<polygon fill="#666666" stroke="#666666" points="169.5,-900.73 166,-890.73 162.5,-900.73 169.5,-900.73"/>
<text xml:space="preserve" text-anchor="middle" x="187.38" y="-917.7" font-family="Helvetica,sans-Serif" font-size="9.00">macro</text>
<text xml:space="preserve" text-anchor="middle" x="187.38" y="-907.95" font-family="Helvetica,sans-Serif" font-size="9.00">expansion</text>
</g>
<g id="node5" class="node">
<title>dispatch_match</title>
<polygon fill="#e8e8f4" stroke="black" points="311,-562.75 21,-562.75 21,-414.75 311,-414.75 311,-562.75"/>
<polygon fill="#e8e8f4" stroke="none" points="29,-541.25 29,-558.75 303,-558.75 303,-541.25 29,-541.25"/>
<text xml:space="preserve" text-anchor="start" x="31" y="-548.25" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">5. __dispatch_attr! matches &quot;column&quot;</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-529.75" font-family="Monaco" font-size="10.00" fill="#6e7781">// Input: column(primary_key)</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-512.25" font-family="Monaco" font-size="10.00" fill="#6e7781">// Scans @variants, finds:</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-495.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;column =&gt; </text>
<text xml:space="preserve" text-anchor="start" x="115" y="-495.75" font-family="Monaco" font-size="10.00" fill="#0550ae">struct</text>
<text xml:space="preserve" text-anchor="start" x="151" y="-495.75" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-478.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="157" y="-478.25" font-family="Monaco" font-size="10.00" fill="#0550ae">bool</text>
<text xml:space="preserve" text-anchor="start" x="181" y="-478.25" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-460.75" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;name: </text>
<text xml:space="preserve" text-anchor="start" x="115" y="-460.75" font-family="Monaco" font-size="10.00" fill="#0550ae">Option</text>
<text xml:space="preserve" text-anchor="start" x="151" y="-460.75" font-family="Monaco" font-size="10.00">&lt;</text>
<text xml:space="preserve" text-anchor="start" x="157" y="-460.75" font-family="Monaco" font-size="10.00" fill="#0550ae">String</text>
<text xml:space="preserve" text-anchor="start" x="193" y="-460.75" font-family="Monaco" font-size="10.00">&gt;,</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-442.25" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="31" y="-424.75" font-family="Monaco" font-size="10.00" fill="#6e7781">// Variant type = struct, forwards to builder</text>
</g>
<g id="edge4" class="edge">
<title>parse_attr_def&#45;&gt;dispatch_match</title>
<path fill="none" stroke="#666666" d="M166,-618.05C166,-603.25 166,-588.51 166,-574.57"/>
<polygon fill="#666666" stroke="#666666" points="169.5,-574.57 166,-564.57 162.5,-574.57 169.5,-574.57"/>
<text xml:space="preserve" text-anchor="middle" x="191.5" y="-591.7" font-family="Helvetica,sans-Serif" font-size="9.00">forwards</text>
<text xml:space="preserve" text-anchor="middle" x="191.5" y="-581.95" font-family="Helvetica,sans-Serif" font-size="9.00">with variants</text>
</g>
<g id="node6" class="node">
<title>build_struct</title>
<polygon fill="#e8f0e8" stroke="black" points="293,-359.25 39,-359.25 39,-228.75 293,-228.75 293,-359.25"/>
<polygon fill="#e8f0e8" stroke="none" points="47,-337.75 47,-355.25 285,-355.25 285,-337.75 47,-337.75"/>
<text xml:space="preserve" text-anchor="start" x="49" y="-344.75" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">6. __build_struct_fields! parses tokens</text>
<text xml:space="preserve" text-anchor="start" x="49" y="-326.25" font-family="Monaco" font-size="10.00" fill="#6e7781">// Input tokens: (primary_key)</text>
<text xml:space="preserve" text-anchor="start" x="49" y="-308.75" font-family="Monaco" font-size="10.00" fill="#6e7781">// For each field in struct def:</text>
<text xml:space="preserve" text-anchor="start" x="49" y="-292.25" font-family="Monaco" font-size="10.00" fill="#cf222e">let</text>
<text xml:space="preserve" text-anchor="start" x="67" y="-292.25" font-family="Monaco" font-size="10.00"> primary_key = </text>
<text xml:space="preserve" text-anchor="start" x="157" y="-292.25" font-family="Monaco" font-size="10.00" fill="#0550ae">false</text>
<text xml:space="preserve" text-anchor="start" x="187" y="-292.25" font-family="Monaco" font-size="10.00">; </text>
<text xml:space="preserve" text-anchor="start" x="199" y="-292.25" font-family="Monaco" font-size="10.00" fill="#6e7781">// default</text>
<text xml:space="preserve" text-anchor="start" x="49" y="-274.75" font-family="Monaco" font-size="10.00" fill="#cf222e">let</text>
<text xml:space="preserve" text-anchor="start" x="67" y="-274.75" font-family="Monaco" font-size="10.00"> name = </text>
<text xml:space="preserve" text-anchor="start" x="115" y="-274.75" font-family="Monaco" font-size="10.00" fill="#0550ae">None</text>
<text xml:space="preserve" text-anchor="start" x="139" y="-274.75" font-family="Monaco" font-size="10.00">; &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="199" y="-274.75" font-family="Monaco" font-size="10.00" fill="#6e7781">// default</text>
<text xml:space="preserve" text-anchor="start" x="49" y="-256.25" font-family="Monaco" font-size="10.00" fill="#6e7781">// Parse &quot;primary_key&quot; token:</text>
<text xml:space="preserve" text-anchor="start" x="49" y="-239.75" font-family="Monaco" font-size="10.00">primary_key = </text>
<text xml:space="preserve" text-anchor="start" x="133" y="-239.75" font-family="Monaco" font-size="10.00" fill="#0550ae">true</text>
<text xml:space="preserve" text-anchor="start" x="157" y="-239.75" font-family="Monaco" font-size="10.00">; &#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="199" y="-239.75" font-family="Monaco" font-size="10.00" fill="#6e7781">// matched!</text>
</g>
<g id="edge5" class="edge">
<title>dispatch_match&#45;&gt;build_struct</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M166,-414.33C166,-400.7 166,-386.43 166,-372.68"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="169.5,-372.73 166,-362.73 162.5,-372.73 169.5,-372.73"/>
<text xml:space="preserve" text-anchor="middle" x="191.88" y="-388.2" font-family="Helvetica,sans-Serif" font-size="9.00">struct variant</text>
<text xml:space="preserve" text-anchor="middle" x="191.88" y="-378.45" font-family="Helvetica,sans-Serif" font-size="9.00">matched</text>
</g>
<g id="node7" class="node">
<title>final_value</title>
<polygon fill="#e8f5e9" stroke="black" points="278,-183 54,-183 54,0 278,0 278,-183"/>
<polygon fill="#d4edda" stroke="none" points="62,-161.5 62,-179 270,-179 270,-161.5 62,-161.5"/>
<text xml:space="preserve" text-anchor="start" x="64" y="-168.5" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="10.00">7. Final ExtensionAttr value</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-151" font-family="Monaco" font-size="10.00">::facet_core::</text>
<text xml:space="preserve" text-anchor="start" x="148" y="-151" font-family="Monaco" font-size="10.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="226" y="-151" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-133.5" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;ns: </text>
<text xml:space="preserve" text-anchor="start" x="112" y="-133.5" font-family="Monaco" font-size="10.00" fill="#0a3069">&quot;orm&quot;</text>
<text xml:space="preserve" text-anchor="start" x="142" y="-133.5" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-116" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;key: </text>
<text xml:space="preserve" text-anchor="start" x="118" y="-116" font-family="Monaco" font-size="10.00" fill="#0a3069">&quot;column&quot;</text>
<text xml:space="preserve" text-anchor="start" x="166" y="-116" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-98.5" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;data: </text>
<text xml:space="preserve" text-anchor="start" x="124" y="-98.5" font-family="Monaco" font-size="10.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="130" y="-98.5" font-family="Monaco" font-size="10.00">::orm::</text>
<text xml:space="preserve" text-anchor="start" x="172" y="-98.5" font-family="Monaco" font-size="10.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="208" y="-98.5" font-family="Monaco" font-size="10.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-81" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="190" y="-81" font-family="Monaco" font-size="10.00" fill="#0550ae">true</text>
<text xml:space="preserve" text-anchor="start" x="214" y="-81" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-63.5" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;name: </text>
<text xml:space="preserve" text-anchor="start" x="148" y="-63.5" font-family="Monaco" font-size="10.00" fill="#0550ae">None</text>
<text xml:space="preserve" text-anchor="start" x="172" y="-63.5" font-family="Monaco" font-size="10.00">,</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-45" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;},</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-28.5" font-family="Monaco" font-size="10.00"> &#160;&#160;&#160;shape: &lt;::orm::</text>
<text xml:space="preserve" text-anchor="start" x="178" y="-28.5" font-family="Monaco" font-size="10.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="214" y="-28.5" font-family="Monaco" font-size="10.00">&gt;::SHAPE,</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-10" font-family="Monaco" font-size="10.00">}</text>
</g>
<g id="edge6" class="edge">
<title>build_struct&#45;&gt;final_value</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M166,-228.46C166,-218.09 166,-207.14 166,-196.13"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="169.5,-196.24 166,-186.24 162.5,-196.24 169.5,-196.24"/>
<text xml:space="preserve" text-anchor="middle" x="186.62" y="-202.2" font-family="Helvetica,sans-Serif" font-size="9.00">constructs</text>
</g>
</g>
</svg>
      <p class="diagram-caption">Derive macro delegates to namespace's parser, which produces ExtensionAttr</p>
    </div>

    <h3>2b. __dispatch_attr! Expansion Detail</h3>
    <p>How <code>::facet::__dispatch_attr!</code> routes to the correct handler:</p>
    <div class="diagram">
      <svg width="525pt" height="1055pt"
 viewBox="0.00 0.00 525.00 1055.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1050.75)">
<title>dispatch_detail</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1050.75 521.12,-1050.75 521.12,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="258.56" y="-1023.75" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">__dispatch_attr! Expansion Detail</text>
<g id="node1" class="node">
<title>input</title>
<polygon fill="#fff9e6" stroke="black" points="483.5,-1017.75 38.25,-1017.75 38.25,-790.75 483.5,-790.75 483.5,-1017.75"/>
<polygon fill="#fff3cd" stroke="none" points="46.25,-995.5 46.25,-1013.75 475.5,-1013.75 475.5,-995.5 46.25,-995.5"/>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-1002.3" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Input from __parse_attr!</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-984.05" font-family="Monaco" font-size="11.00">::facet::</text>
<text xml:space="preserve" text-anchor="start" x="109" y="-984.05" font-family="Monaco" font-size="11.00" fill="#8250df">__dispatch_attr!</text>
<text xml:space="preserve" text-anchor="start" x="217" y="-984.05" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-965.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="75.25" y="-965.8" font-family="Monaco" font-size="11.00" fill="#8250df">@namespace</text>
<text xml:space="preserve" text-anchor="start" x="142.75" y="-965.8" font-family="Monaco" font-size="11.00"> { </text>
<text xml:space="preserve" text-anchor="start" x="163" y="-965.8" font-family="Monaco" font-size="11.00" fill="#953800">$crate</text>
<text xml:space="preserve" text-anchor="start" x="203.5" y="-965.8" font-family="Monaco" font-size="11.00"> } &#160;</text>
<text xml:space="preserve" text-anchor="start" x="230.5" y="-965.8" font-family="Monaco" font-size="11.00" fill="#6e7781">// = ::orm</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-947.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="75.25" y="-947.55" font-family="Monaco" font-size="11.00" fill="#8250df">@enum_name</text>
<text xml:space="preserve" text-anchor="start" x="142.75" y="-947.55" font-family="Monaco" font-size="11.00"> { </text>
<text xml:space="preserve" text-anchor="start" x="163" y="-947.55" font-family="Monaco" font-size="11.00" fill="#0550ae">Attr</text>
<text xml:space="preserve" text-anchor="start" x="190" y="-947.55" font-family="Monaco" font-size="11.00"> }</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-929.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="75.25" y="-929.3" font-family="Monaco" font-size="11.00" fill="#8250df">@variants</text>
<text xml:space="preserve" text-anchor="start" x="136" y="-929.3" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-910.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;skip: unit,</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-892.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;rename: newtype </text>
<text xml:space="preserve" text-anchor="start" x="210.25" y="-892.8" font-family="Monaco" font-size="11.00" fill="#0550ae">&amp;&#39;static str</text>
<text xml:space="preserve" text-anchor="start" x="291.25" y="-892.8" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-874.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;column: rec </text>
<text xml:space="preserve" text-anchor="start" x="183.25" y="-874.55" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="223.75" y="-874.55" font-family="Monaco" font-size="11.00"> { primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="331.75" y="-874.55" font-family="Monaco" font-size="11.00" fill="#0550ae">bool</text>
<text xml:space="preserve" text-anchor="start" x="358.75" y="-874.55" font-family="Monaco" font-size="11.00">, name: opt_str }</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-855.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-838.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="75.25" y="-838.05" font-family="Monaco" font-size="11.00" fill="#8250df">@name</text>
<text xml:space="preserve" text-anchor="start" x="109" y="-838.05" font-family="Monaco" font-size="11.00"> { column } &#160;</text>
<text xml:space="preserve" text-anchor="start" x="196.75" y="-838.05" font-family="Monaco" font-size="11.00" fill="#6e7781">// from user&#39;s attr</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-819.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="75.25" y="-819.8" font-family="Monaco" font-size="11.00" fill="#8250df">@rest</text>
<text xml:space="preserve" text-anchor="start" x="109" y="-819.8" font-family="Monaco" font-size="11.00"> { (primary_key) } &#160;</text>
<text xml:space="preserve" text-anchor="start" x="244" y="-819.8" font-family="Monaco" font-size="11.00" fill="#6e7781">// remaining tokens</text>
<text xml:space="preserve" text-anchor="start" x="48.25" y="-800.55" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="node2" class="node">
<title>lookup</title>
<polygon fill="#e8e8f4" stroke="black" points="260.88,-753.75 4.63,-709.25 260.87,-664.75 517.12,-709.25 260.88,-753.75"/>
<text xml:space="preserve" text-anchor="start" x="213.62" y="-716.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Variant Lookup</text>
<text xml:space="preserve" text-anchor="start" x="142.75" y="-697.8" font-family="Monaco, Consolas, Courier" font-size="11.00">Match </text>
<text xml:space="preserve" text-anchor="start" x="183.25" y="-697.8" font-family="Monaco" font-size="11.00">column</text>
<text xml:space="preserve" text-anchor="start" x="223.75" y="-697.8" font-family="Monaco, Consolas, Courier" font-size="11.00"> against known variants</text>
</g>
<g id="edge1" class="edge">
<title>input&#45;&gt;lookup</title>
<path fill="none" stroke="black" d="M260.88,-790.42C260.88,-781.78 260.88,-773.31 260.88,-765.31"/>
<polygon fill="black" stroke="black" points="264.38,-765.48 260.88,-755.48 257.38,-765.48 264.38,-765.48"/>
</g>
<g id="node3" class="node">
<title>found_struct</title>
<polygon fill="#e8f5e9" stroke="black" points="256.25,-617.5 13.5,-617.5 13.5,-573 256.25,-573 256.25,-617.5"/>
<polygon fill="#d4edda" stroke="none" points="21.5,-595.25 21.5,-613.5 248.25,-613.5 248.25,-595.25 21.5,-595.25"/>
<text xml:space="preserve" text-anchor="start" x="23.5" y="-602.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Found: struct variant (column) ✓</text>
<text xml:space="preserve" text-anchor="start" x="23.5" y="-583.8" font-family="Monaco, Consolas, Courier" font-size="11.00">Forward to </text>
<text xml:space="preserve" text-anchor="start" x="97.75" y="-583.8" font-family="Monaco" font-size="11.00" fill="#8250df">__build_struct_fields!</text>
</g>
<g id="edge2" class="edge">
<title>lookup&#45;&gt;found_struct</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M219.62,-671.58C203.09,-656.89 184.3,-640.18 168.61,-626.24"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="171.36,-624 161.56,-619.97 166.71,-629.23 171.36,-624"/>
<text xml:space="preserve" text-anchor="middle" x="218.83" y="-637.25" font-family="Helvetica,sans-Serif" font-size="10.00">struct variant</text>
</g>
<g id="node7" class="node">
<title>not_found</title>
<polygon fill="#f8d7da" stroke="black" points="497.12,-617.5 274.62,-617.5 274.62,-573 497.12,-573 497.12,-617.5"/>
<polygon fill="#f8d7da" stroke="none" points="282.62,-595.25 282.62,-613.5 489.12,-613.5 489.12,-595.25 282.62,-595.25"/>
<text xml:space="preserve" text-anchor="start" x="352.12" y="-602.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Not found?</text>
<text xml:space="preserve" text-anchor="start" x="284.62" y="-583.8" font-family="Monaco" font-size="11.00" fill="#8250df">__attr_error!</text>
<text xml:space="preserve" text-anchor="start" x="372.38" y="-583.8" font-family="Monaco, Consolas, Courier" font-size="11.00"> with suggestions</text>
</g>
<g id="edge3" class="edge">
<title>lookup&#45;&gt;not_found</title>
<path fill="none" stroke="#dc3545" stroke-dasharray="5,2" d="M301.8,-671.58C318.51,-656.61 337.55,-639.55 353.28,-625.45"/>
<polygon fill="#dc3545" stroke="#dc3545" points="355.41,-628.25 360.52,-618.97 350.74,-623.03 355.41,-628.25"/>
<text xml:space="preserve" text-anchor="middle" x="361.38" y="-637.25" font-family="Helvetica,sans-Serif" font-size="10.00">unknown</text>
</g>
<g id="node4" class="node">
<title>build_fields</title>
<polygon fill="#fff9e6" stroke="black" points="259.62,-536 10.13,-536 10.13,-345.5 259.62,-345.5 259.62,-536"/>
<polygon fill="#fff3cd" stroke="none" points="18.12,-513.75 18.12,-532 251.62,-532 251.62,-513.75 18.12,-513.75"/>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-520.55" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">::facet::__build_struct_fields!</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-502.3" font-family="Monaco" font-size="11.00">::facet::</text>
<text xml:space="preserve" text-anchor="start" x="80.88" y="-502.3" font-family="Monaco" font-size="11.00" fill="#8250df">__build_struct_fields!</text>
<text xml:space="preserve" text-anchor="start" x="229.38" y="-502.3" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-484.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="47.12" y="-484.05" font-family="Monaco" font-size="11.00" fill="#8250df">@namespace</text>
<text xml:space="preserve" text-anchor="start" x="114.62" y="-484.05" font-family="Monaco" font-size="11.00"> { ::orm }</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-465.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="47.12" y="-465.8" font-family="Monaco" font-size="11.00" fill="#8250df">@struct_name</text>
<text xml:space="preserve" text-anchor="start" x="128.12" y="-465.8" font-family="Monaco" font-size="11.00"> { </text>
<text xml:space="preserve" text-anchor="start" x="148.38" y="-465.8" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="188.88" y="-465.8" font-family="Monaco" font-size="11.00"> }</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-447.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="47.12" y="-447.55" font-family="Monaco" font-size="11.00" fill="#8250df">@fields</text>
<text xml:space="preserve" text-anchor="start" x="94.38" y="-447.55" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-429.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="161.88" y="-429.3" font-family="Monaco" font-size="11.00" fill="#0550ae">bool</text>
<text xml:space="preserve" text-anchor="start" x="188.88" y="-429.3" font-family="Monaco" font-size="11.00"> = </text>
<text xml:space="preserve" text-anchor="start" x="209.12" y="-429.3" font-family="Monaco" font-size="11.00" fill="#0550ae">false</text>
<text xml:space="preserve" text-anchor="start" x="242.88" y="-429.3" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-411.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;name: opt_str = </text>
<text xml:space="preserve" text-anchor="start" x="182.12" y="-411.05" font-family="Monaco" font-size="11.00" fill="#0550ae">None</text>
<text xml:space="preserve" text-anchor="start" x="209.12" y="-411.05" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-391.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;}</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-374.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="47.12" y="-374.55" font-family="Monaco" font-size="11.00" fill="#8250df">@input</text>
<text xml:space="preserve" text-anchor="start" x="87.62" y="-374.55" font-family="Monaco" font-size="11.00"> { (primary_key) }</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-355.3" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="edge4" class="edge">
<title>found_struct&#45;&gt;build_fields</title>
<path fill="none" stroke="black" d="M134.88,-572.72C134.88,-565.47 134.88,-556.81 134.88,-547.45"/>
<polygon fill="black" stroke="black" points="138.38,-547.7 134.88,-537.7 131.38,-547.7 138.38,-547.7"/>
</g>
<g id="node5" class="node">
<title>field_parse</title>
<polygon fill="#e8e8f4" stroke="black" points="269.75,-308.5 0,-308.5 0,-227.5 269.75,-227.5 269.75,-308.5"/>
<polygon fill="#e8e8f4" stroke="none" points="8,-286.25 8,-304.5 261.75,-304.5 261.75,-286.25 8,-286.25"/>
<text xml:space="preserve" text-anchor="start" x="91" y="-293.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Field Parsing</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-273.8" font-family="Monaco, Consolas, Courier" font-size="11.00">For each token in input:</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-256.55" font-family="Monaco" font-size="11.00">primary_key</text>
<text xml:space="preserve" text-anchor="start" x="84.25" y="-256.55" font-family="Monaco, Consolas, Courier" font-size="11.00"> → set </text>
<text xml:space="preserve" text-anchor="start" x="131.5" y="-256.55" font-family="Monaco" font-size="11.00">primary_key = </text>
<text xml:space="preserve" text-anchor="start" x="226" y="-256.55" font-family="Monaco" font-size="11.00" fill="#0550ae">true</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-238.3" font-family="Monaco" font-size="11.00">name = </text>
<text xml:space="preserve" text-anchor="start" x="57.25" y="-238.3" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;foo&quot;</text>
<text xml:space="preserve" text-anchor="start" x="91" y="-238.3" font-family="Monaco, Consolas, Courier" font-size="11.00"> → set </text>
<text xml:space="preserve" text-anchor="start" x="138.25" y="-238.3" font-family="Monaco" font-size="11.00">name = </text>
<text xml:space="preserve" text-anchor="start" x="185.5" y="-238.3" font-family="Monaco" font-size="11.00" fill="#0550ae">Some</text>
<text xml:space="preserve" text-anchor="start" x="212.5" y="-238.3" font-family="Monaco" font-size="11.00">(</text>
<text xml:space="preserve" text-anchor="start" x="219.25" y="-238.3" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;foo&quot;</text>
<text xml:space="preserve" text-anchor="start" x="253" y="-238.3" font-family="Monaco" font-size="11.00">)</text>
</g>
<g id="edge5" class="edge">
<title>build_fields&#45;&gt;field_parse</title>
<path fill="none" stroke="black" d="M134.88,-345.39C134.88,-336.78 134.88,-328.3 134.88,-320.3"/>
<polygon fill="black" stroke="black" points="138.38,-320.48 134.88,-310.48 131.38,-320.48 138.38,-320.48"/>
</g>
<g id="node6" class="node">
<title>output</title>
<polygon fill="#e8f5e9" stroke="black" points="259.62,-190.5 10.13,-190.5 10.13,0 259.62,0 259.62,-190.5"/>
<polygon fill="#d4edda" stroke="none" points="18.12,-168.25 18.12,-186.5 251.62,-186.5 251.62,-168.25 18.12,-168.25"/>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-175.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Final Output</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-156.8" font-family="Monaco" font-size="11.00">::facet_core::</text>
<text xml:space="preserve" text-anchor="start" x="114.62" y="-156.8" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="202.38" y="-156.8" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-138.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;ns: </text>
<text xml:space="preserve" text-anchor="start" x="74.12" y="-138.55" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;orm&quot;</text>
<text xml:space="preserve" text-anchor="start" x="107.88" y="-138.55" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-120.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;key: </text>
<text xml:space="preserve" text-anchor="start" x="80.88" y="-120.3" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;column&quot;</text>
<text xml:space="preserve" text-anchor="start" x="134.88" y="-120.3" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-102.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;data: </text>
<text xml:space="preserve" text-anchor="start" x="87.62" y="-102.05" font-family="Monaco" font-size="11.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="94.38" y="-102.05" font-family="Monaco" font-size="11.00">::orm::</text>
<text xml:space="preserve" text-anchor="start" x="141.62" y="-102.05" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="182.12" y="-102.05" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-83.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;primary_key: </text>
<text xml:space="preserve" text-anchor="start" x="161.88" y="-83.8" font-family="Monaco" font-size="11.00" fill="#0550ae">true</text>
<text xml:space="preserve" text-anchor="start" x="188.88" y="-83.8" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-65.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;name: </text>
<text xml:space="preserve" text-anchor="start" x="114.62" y="-65.55" font-family="Monaco" font-size="11.00" fill="#0550ae">None</text>
<text xml:space="preserve" text-anchor="start" x="141.62" y="-65.55" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-46.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;},</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-29.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;shape: &lt;::orm::</text>
<text xml:space="preserve" text-anchor="start" x="148.38" y="-29.05" font-family="Monaco" font-size="11.00" fill="#0550ae">Column</text>
<text xml:space="preserve" text-anchor="start" x="188.88" y="-29.05" font-family="Monaco" font-size="11.00">&gt;::SHAPE,</text>
<text xml:space="preserve" text-anchor="start" x="20.12" y="-9.8" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="edge6" class="edge">
<title>field_parse&#45;&gt;output</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M134.88,-227.4C134.88,-220 134.88,-211.96 134.88,-203.62"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="138.38,-203.8 134.88,-193.8 131.38,-203.8 138.38,-203.8"/>
</g>
</g>
</svg>
      <p class="diagram-caption">Dispatches to unit/newtype/struct handlers, or __attr_error! if not found</p>
    </div>

    <h3>3. Error Flow</h3>
    <p>How typos get helpful suggestions:</p>
    <div class="diagram">
      <svg width="305pt" height="715pt"
 viewBox="0.00 0.00 305.00 715.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 711.25)">
<title>error_flow</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-711.25 300.75,-711.25 300.75,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="148.38" y="-684.25" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">Error Flow (typo handling)</text>
<g id="node1" class="node">
<title>typo</title>
<polygon fill="#fff8f0" stroke="black" points="269.75,-678.25 27,-678.25 27,-615.5 269.75,-615.5 269.75,-678.25"/>
<polygon fill="#fff8f0" stroke="none" points="35,-656 35,-674.25 261.75,-674.25 261.75,-656 35,-656"/>
<text xml:space="preserve" text-anchor="start" x="37" y="-662.8" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">User code with typo</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-644.55" font-family="Monaco" font-size="11.00">#[</text>
<text xml:space="preserve" text-anchor="start" x="50.5" y="-644.55" font-family="Monaco" font-size="11.00" fill="#8250df">facet</text>
<text xml:space="preserve" text-anchor="start" x="84.25" y="-644.55" font-family="Monaco" font-size="11.00">(orm::</text>
<text xml:space="preserve" text-anchor="start" x="124.75" y="-644.55" font-family="Monaco" font-size="11.00" fill="#dc3545">colum</text>
<text xml:space="preserve" text-anchor="start" x="158.5" y="-644.55" font-family="Monaco" font-size="11.00">(primary_key))]</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-625.3" font-family="Monaco, Consolas, Courier" font-size="11.00" fill="#dc3545"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^^^^^ typo!</text>
</g>
<g id="node2" class="node">
<title>dispatch</title>
<polygon fill="#e8e8f4" stroke="black" points="256.25,-568.25 40.5,-568.25 40.5,-487.25 256.25,-487.25 256.25,-568.25"/>
<polygon fill="#e8e8f4" stroke="none" points="48.5,-546 48.5,-564.25 248.25,-564.25 248.25,-546 48.5,-546"/>
<text xml:space="preserve" text-anchor="start" x="91" y="-552.8" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">facet&#45;macros&#45;impl</text>
<text xml:space="preserve" text-anchor="start" x="64" y="-534.55" font-family="Monaco" font-size="11.00">::facet::</text>
<text xml:space="preserve" text-anchor="start" x="124.75" y="-534.55" font-family="Monaco" font-size="11.00" fill="#8250df">__dispatch_attr!</text>
<text xml:space="preserve" text-anchor="start" x="50.5" y="-516.3" font-family="Monaco, Consolas, Courier" font-size="11.00">Looks up </text>
<text xml:space="preserve" text-anchor="start" x="111.25" y="-516.3" font-family="Monaco" font-size="11.00" fill="#dc3545">&#39;colum&#39;</text>
<text xml:space="preserve" text-anchor="start" x="158.5" y="-516.3" font-family="Monaco, Consolas, Courier" font-size="11.00"> in @variants</text>
<text xml:space="preserve" text-anchor="start" x="114.62" y="-498.05" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Not found!</text>
</g>
<g id="edge1" class="edge">
<title>typo&#45;&gt;dispatch</title>
<path fill="none" stroke="#666666" d="M148.38,-615.1C148.38,-604.32 148.38,-591.89 148.38,-579.89"/>
<polygon fill="#666666" stroke="#666666" points="151.88,-580.1 148.38,-570.1 144.88,-580.1 151.88,-580.1"/>
<text xml:space="preserve" text-anchor="middle" x="177.62" y="-588" font-family="Helvetica,sans-Serif" font-size="10.00">processed by</text>
</g>
<g id="node3" class="node">
<title>attr_error</title>
<polygon fill="#fff9e6" stroke="black" points="296.75,-440 0,-440 0,-322.5 296.75,-322.5 296.75,-440"/>
<polygon fill="#fff3cd" stroke="none" points="8,-417.75 8,-436 288.75,-436 288.75,-417.75 8,-417.75"/>
<text xml:space="preserve" text-anchor="start" x="10" y="-424.55" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">facet&#45;macros&#45;impl</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-406.3" font-family="Monaco" font-size="11.00">::facet::</text>
<text xml:space="preserve" text-anchor="start" x="70.75" y="-406.3" font-family="Monaco" font-size="11.00" fill="#8250df">__attr_error!</text>
<text xml:space="preserve" text-anchor="start" x="158.5" y="-406.3" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-388.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-388.05" font-family="Monaco" font-size="11.00" fill="#8250df">@known_attrs</text>
<text xml:space="preserve" text-anchor="start" x="118" y="-388.05" font-family="Monaco" font-size="11.00"> { skip, column, rename }</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-369.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-369.8" font-family="Monaco" font-size="11.00" fill="#8250df">@got_name</text>
<text xml:space="preserve" text-anchor="start" x="97.75" y="-369.8" font-family="Monaco" font-size="11.00"> { </text>
<text xml:space="preserve" text-anchor="start" x="118" y="-369.8" font-family="Monaco" font-size="11.00" fill="#dc3545">colum</text>
<text xml:space="preserve" text-anchor="start" x="151.75" y="-369.8" font-family="Monaco" font-size="11.00"> }</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-351.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="37" y="-351.55" font-family="Monaco" font-size="11.00" fill="#8250df">@got_span</text>
<text xml:space="preserve" text-anchor="start" x="97.75" y="-351.55" font-family="Monaco" font-size="11.00"> { ... }</text>
<text xml:space="preserve" text-anchor="start" x="10" y="-332.3" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="edge2" class="edge">
<title>dispatch&#45;&gt;attr_error</title>
<path fill="none" stroke="#dc3545" stroke-width="2" d="M148.38,-486.88C148.38,-476.44 148.38,-464.87 148.38,-453.33"/>
<polygon fill="#dc3545" stroke="#dc3545" stroke-width="2" points="151.88,-453.41 148.38,-443.41 144.88,-453.41 151.88,-453.41"/>
<text xml:space="preserve" text-anchor="middle" x="184.75" y="-459.75" font-family="Helvetica,sans-Serif" font-size="10.00">variant not found</text>
</g>
<g id="node4" class="node">
<title>strsim</title>
<polygon fill="#e8f5e9" stroke="black" points="290,-275.25 6.75,-275.25 6.75,-194.25 290,-194.25 290,-275.25"/>
<polygon fill="#e8f5e9" stroke="none" points="14.75,-253 14.75,-271.25 282,-271.25 282,-253 14.75,-253"/>
<text xml:space="preserve" text-anchor="start" x="107.88" y="-259.8" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">strsim crate</text>
<text xml:space="preserve" text-anchor="start" x="16.75" y="-241.55" font-family="Monaco" font-size="11.00">strsim::jaro_winkler(</text>
<text xml:space="preserve" text-anchor="start" x="158.5" y="-241.55" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;colum&quot;</text>
<text xml:space="preserve" text-anchor="start" x="205.75" y="-241.55" font-family="Monaco" font-size="11.00">, </text>
<text xml:space="preserve" text-anchor="start" x="219.25" y="-241.55" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;column&quot;</text>
<text xml:space="preserve" text-anchor="start" x="273.25" y="-241.55" font-family="Monaco" font-size="11.00">)</text>
<text xml:space="preserve" text-anchor="start" x="47.12" y="-223.3" font-family="Monaco, Consolas, Courier" font-size="11.00">Returns </text>
<text xml:space="preserve" text-anchor="start" x="101.12" y="-223.3" font-family="Monaco" font-size="11.00">0.96</text>
<text xml:space="preserve" text-anchor="start" x="128.12" y="-223.3" font-family="Monaco, Consolas, Courier" font-size="11.00"> (high similarity)</text>
<text xml:space="preserve" text-anchor="start" x="80.88" y="-205.05" font-family="Monaco, Consolas, Courier" font-size="11.00">Best match: </text>
<text xml:space="preserve" text-anchor="start" x="161.88" y="-205.05" font-family="Monaco" font-size="11.00" fill="#228b22">&quot;column&quot;</text>
</g>
<g id="edge3" class="edge">
<title>attr_error&#45;&gt;strsim</title>
<path fill="none" stroke="#666666" d="M148.38,-322.31C148.38,-310.53 148.38,-298.23 148.38,-286.71"/>
<polygon fill="#666666" stroke="#666666" points="151.88,-287.02 148.38,-277.02 144.88,-287.02 151.88,-287.02"/>
<text xml:space="preserve" text-anchor="middle" x="172" y="-295" font-family="Helvetica,sans-Serif" font-size="10.00">find similar</text>
</g>
<g id="node5" class="node">
<title>error_output</title>
<polygon fill="#f8d7da" stroke="black" points="273.12,-135.75 23.63,-135.75 23.63,0 273.12,0 273.12,-135.75"/>
<polygon fill="#f8d7da" stroke="none" points="31.62,-113.5 31.62,-131.75 265.12,-131.75 265.12,-113.5 31.62,-113.5"/>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-120.3" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Compiler output</text>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-101.05" font-family="Monaco" font-size="11.00" fill="#dc3545">error: unknown attribute `colum`</text>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-82.8" font-family="Monaco" font-size="11.00" fill="#dc3545"> &#160;&#160;&#160;&#160;&#160;&#160;did you mean `column`?</text>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-64.55" font-family="Monaco" font-size="11.00"> &#160;&#45;&#45;&gt; src/lib.rs:3:13</text>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-46.3" font-family="Monaco" font-size="11.00"> &#160;&#160;|</text>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-28.05" font-family="Monaco" font-size="11.00">3 &#160;| &#160;&#160;&#160;&#160;#[facet(orm::colum(...))]</text>
<text xml:space="preserve" text-anchor="start" x="33.62" y="-10.8" font-family="Monaco" font-size="11.00"> &#160;&#160;| &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="182.12" y="-10.8" font-family="Monaco" font-size="11.00" fill="#dc3545">^^^^^</text>
</g>
<g id="edge4" class="edge">
<title>strsim&#45;&gt;error_output</title>
<path fill="none" stroke="#dc3545" stroke-width="2" d="M148.38,-193.84C148.38,-180.29 148.38,-164.63 148.38,-149.07"/>
<polygon fill="#dc3545" stroke="#dc3545" stroke-width="2" points="151.88,-149.1 148.38,-139.1 144.88,-149.1 151.88,-149.1"/>
<text xml:space="preserve" text-anchor="middle" x="186.25" y="-166.75" font-family="Helvetica,sans-Serif" font-size="10.00">compile_error!</text>
<text xml:space="preserve" text-anchor="middle" x="186.25" y="-155.5" font-family="Helvetica,sans-Serif" font-size="10.00">with original span</text>
</g>
</g>
</svg>
      <p class="diagram-caption">strsim finds similar attribute names for "did you mean?" suggestions</p>
    </div>

    <h3>4. Storage Model</h3>
    <p>How everything becomes <code>::facet_core::ExtensionAttr</code>:</p>
    <div class="diagram">
      <svg width="885pt" height="352pt"
 viewBox="0.00 0.00 885.00 352.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 348)">
<title>storage_model</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-348 880.5,-348 880.5,4 -4,4"/>
<text xml:space="preserve" text-anchor="middle" x="438.25" y="-321" font-family="Helvetica,sans-Serif" font-weight="bold" font-size="20.00">Storage Model: Everything becomes ExtensionAttr</text>
<g id="clust1" class="cluster">
<title>cluster_input</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="8,-63 8,-251 260,-251 260,-63 8,-63"/>
<text xml:space="preserve" text-anchor="middle" x="134" y="-228" font-family="Helvetica,sans-Serif" font-size="20.00">User writes</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_output</title>
<polygon fill="none" stroke="black" stroke-dasharray="5,2" points="280,-8 280,-307 632.75,-307 632.75,-8 280,-8"/>
<text xml:space="preserve" text-anchor="middle" x="456.38" y="-284" font-family="Helvetica,sans-Serif" font-size="20.00">All become ::facet_core::ExtensionAttr</text>
</g>
<g id="node1" class="node">
<title>builtin</title>
<polygon fill="#fff8f0" stroke="black" points="241.88,-133.38 26.12,-133.38 26.12,-70.62 241.88,-70.62 241.88,-133.38"/>
<polygon fill="#fff8f0" stroke="none" points="34.12,-111.12 34.12,-129.38 233.88,-129.38 233.88,-111.12 34.12,-111.12"/>
<text xml:space="preserve" text-anchor="start" x="36.12" y="-117.92" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Built&#45;in attrs (no namespace)</text>
<text xml:space="preserve" text-anchor="start" x="36.12" y="-99.67" font-family="Monaco" font-size="11.00">#[</text>
<text xml:space="preserve" text-anchor="start" x="49.62" y="-99.67" font-family="Monaco" font-size="11.00" fill="#8250df">facet</text>
<text xml:space="preserve" text-anchor="start" x="83.38" y="-99.67" font-family="Monaco" font-size="11.00">(skip)]</text>
<text xml:space="preserve" text-anchor="start" x="36.12" y="-81.42" font-family="Monaco" font-size="11.00">#[</text>
<text xml:space="preserve" text-anchor="start" x="49.62" y="-81.42" font-family="Monaco" font-size="11.00" fill="#8250df">facet</text>
<text xml:space="preserve" text-anchor="start" x="83.38" y="-81.42" font-family="Monaco" font-size="11.00">(rename = </text>
<text xml:space="preserve" text-anchor="start" x="150.88" y="-81.42" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;foo&quot;</text>
<text xml:space="preserve" text-anchor="start" x="184.62" y="-81.42" font-family="Monaco" font-size="11.00">)]</text>
</g>
<g id="node3" class="node">
<title>ext1</title>
<polygon fill="#e8f5e9" stroke="black" points="573.88,-133.75 337.88,-133.75 337.88,-16.25 573.88,-16.25 573.88,-133.75"/>
<text xml:space="preserve" text-anchor="start" x="347.88" y="-118.3" font-family="Monaco" font-size="11.00">::facet_core::</text>
<text xml:space="preserve" text-anchor="start" x="442.38" y="-118.3" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="530.12" y="-118.3" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="347.88" y="-100.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;ns: </text>
<text xml:space="preserve" text-anchor="start" x="401.88" y="-100.05" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;&quot;</text>
<text xml:space="preserve" text-anchor="start" x="415.38" y="-100.05" font-family="Monaco" font-size="11.00">, &#160;</text>
<text xml:space="preserve" text-anchor="start" x="435.62" y="-100.05" font-family="Monaco" font-size="11.00" fill="#6e7781">// empty = built&#45;in</text>
<text xml:space="preserve" text-anchor="start" x="347.88" y="-81.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;key: </text>
<text xml:space="preserve" text-anchor="start" x="408.62" y="-81.8" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;skip&quot;</text>
<text xml:space="preserve" text-anchor="start" x="449.12" y="-81.8" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="347.88" y="-63.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;data: </text>
<text xml:space="preserve" text-anchor="start" x="415.38" y="-63.55" font-family="Monaco" font-size="11.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="422.12" y="-63.55" font-family="Monaco" font-size="11.00">() </text>
<text xml:space="preserve" text-anchor="start" x="442.38" y="-63.55" font-family="Monaco" font-size="11.00" fill="#cf222e">as</text>
<text xml:space="preserve" text-anchor="start" x="455.88" y="-63.55" font-family="Monaco" font-size="11.00"> *</text>
<text xml:space="preserve" text-anchor="start" x="469.38" y="-63.55" font-family="Monaco" font-size="11.00" fill="#cf222e">const</text>
<text xml:space="preserve" text-anchor="start" x="503.12" y="-63.55" font-family="Monaco" font-size="11.00"> (),</text>
<text xml:space="preserve" text-anchor="start" x="347.88" y="-44.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;shape: &lt;()&gt;::SHAPE,</text>
<text xml:space="preserve" text-anchor="start" x="347.88" y="-26.05" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="edge1" class="edge">
<title>builtin&#45;&gt;ext1</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M241.96,-92.97C268.46,-90.74 297.14,-88.31 324.61,-86"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="324.88,-89.49 334.55,-85.16 324.29,-82.51 324.88,-89.49"/>
</g>
<g id="node2" class="node">
<title>extension</title>
<polygon fill="#f4e8e8" stroke="black" points="252,-214.38 16,-214.38 16,-151.62 252,-151.62 252,-214.38"/>
<polygon fill="#f4e8e8" stroke="none" points="24,-192.12 24,-210.38 244,-210.38 244,-192.12 24,-192.12"/>
<text xml:space="preserve" text-anchor="start" x="26" y="-198.93" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Extension attrs (with namespace)</text>
<text xml:space="preserve" text-anchor="start" x="26" y="-180.68" font-family="Monaco" font-size="11.00">#[</text>
<text xml:space="preserve" text-anchor="start" x="39.5" y="-180.68" font-family="Monaco" font-size="11.00" fill="#8250df">facet</text>
<text xml:space="preserve" text-anchor="start" x="73.25" y="-180.68" font-family="Monaco" font-size="11.00">(kdl::child)]</text>
<text xml:space="preserve" text-anchor="start" x="26" y="-162.43" font-family="Monaco" font-size="11.00">#[</text>
<text xml:space="preserve" text-anchor="start" x="39.5" y="-162.43" font-family="Monaco" font-size="11.00" fill="#8250df">facet</text>
<text xml:space="preserve" text-anchor="start" x="73.25" y="-162.43" font-family="Monaco" font-size="11.00">(orm::column(pk))]</text>
</g>
<g id="node4" class="node">
<title>ext2</title>
<polygon fill="#e8f5e9" stroke="black" points="563.75,-269.75 348,-269.75 348,-152.25 563.75,-152.25 563.75,-269.75"/>
<text xml:space="preserve" text-anchor="start" x="358" y="-254.3" font-family="Monaco" font-size="11.00">::facet_core::</text>
<text xml:space="preserve" text-anchor="start" x="452.5" y="-254.3" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="540.25" y="-254.3" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="358" y="-236.05" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;ns: </text>
<text xml:space="preserve" text-anchor="start" x="412" y="-236.05" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;kdl&quot;</text>
<text xml:space="preserve" text-anchor="start" x="445.75" y="-236.05" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="358" y="-217.8" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;key: </text>
<text xml:space="preserve" text-anchor="start" x="418.75" y="-217.8" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;child&quot;</text>
<text xml:space="preserve" text-anchor="start" x="466" y="-217.8" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="358" y="-199.55" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;data: </text>
<text xml:space="preserve" text-anchor="start" x="425.5" y="-199.55" font-family="Monaco" font-size="11.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="432.25" y="-199.55" font-family="Monaco" font-size="11.00">() </text>
<text xml:space="preserve" text-anchor="start" x="452.5" y="-199.55" font-family="Monaco" font-size="11.00" fill="#cf222e">as</text>
<text xml:space="preserve" text-anchor="start" x="466" y="-199.55" font-family="Monaco" font-size="11.00"> *</text>
<text xml:space="preserve" text-anchor="start" x="479.5" y="-199.55" font-family="Monaco" font-size="11.00" fill="#cf222e">const</text>
<text xml:space="preserve" text-anchor="start" x="513.25" y="-199.55" font-family="Monaco" font-size="11.00"> (),</text>
<text xml:space="preserve" text-anchor="start" x="358" y="-180.3" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;shape: &lt;()&gt;::SHAPE,</text>
<text xml:space="preserve" text-anchor="start" x="358" y="-162.05" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="edge2" class="edge">
<title>extension&#45;&gt;ext2</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M252.29,-193.27C279.23,-195.63 307.91,-198.14 334.96,-200.5"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="334.39,-203.97 344.65,-201.35 335,-196.99 334.39,-203.97"/>
</g>
<g id="node5" class="node">
<title>field</title>
<polygon fill="#e8f5e9" stroke="black" points="876.5,-229.12 660.75,-229.12 660.75,-56.88 876.5,-56.88 876.5,-229.12"/>
<polygon fill="#d4edda" stroke="none" points="668.75,-206.88 668.75,-225.12 868.5,-225.12 868.5,-206.88 668.75,-206.88"/>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-213.68" font-family="Monaco, Consolas, Courier" font-weight="bold" font-size="11.00">Stored in ::facet_core::Field</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-195.43" font-family="Monaco" font-size="11.00">::facet_core::</text>
<text xml:space="preserve" text-anchor="start" x="765.25" y="-195.43" font-family="Monaco" font-size="11.00" fill="#0550ae">Field</text>
<text xml:space="preserve" text-anchor="start" x="799" y="-195.43" font-family="Monaco" font-size="11.00"> {</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-177.18" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;name: </text>
<text xml:space="preserve" text-anchor="start" x="738.25" y="-177.18" font-family="Monaco" font-size="11.00" fill="#0a3069">&quot;...&quot;</text>
<text xml:space="preserve" text-anchor="start" x="772" y="-177.18" font-family="Monaco" font-size="11.00">,</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-158.93" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;attributes: </text>
<text xml:space="preserve" text-anchor="start" x="778.75" y="-158.93" font-family="Monaco" font-size="11.00" fill="#cf222e">&amp;</text>
<text xml:space="preserve" text-anchor="start" x="785.5" y="-158.93" font-family="Monaco" font-size="11.00" fill="#0550ae">&#39;static</text>
<text xml:space="preserve" text-anchor="start" x="832.75" y="-158.93" font-family="Monaco" font-size="11.00"> [</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-140.68" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="724.75" y="-140.68" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="812.5" y="-140.68" font-family="Monaco" font-size="11.00"> {...},</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-122.42" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text xml:space="preserve" text-anchor="start" x="724.75" y="-122.42" font-family="Monaco" font-size="11.00" fill="#0550ae">ExtensionAttr</text>
<text xml:space="preserve" text-anchor="start" x="812.5" y="-122.42" font-family="Monaco" font-size="11.00"> {...},</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-103.17" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;],</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-84.92" font-family="Monaco" font-size="11.00"> &#160;&#160;&#160;...</text>
<text xml:space="preserve" text-anchor="start" x="670.75" y="-66.67" font-family="Monaco" font-size="11.00">}</text>
</g>
<g id="edge3" class="edge">
<title>ext1&#45;&gt;field</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M574.36,-100.71C598.43,-105.98 623.8,-111.53 647.95,-116.81"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="646.99,-120.18 657.5,-118.9 648.48,-113.35 646.99,-120.18"/>
</g>
<g id="edge4" class="edge">
<title>ext2&#45;&gt;field</title>
<path fill="none" stroke="#228b22" stroke-width="2" d="M563.82,-187.6C590.92,-181.67 620.2,-175.26 647.89,-169.2"/>
<polygon fill="#228b22" stroke="#228b22" stroke-width="2" points="648.51,-172.65 657.53,-167.09 647.01,-165.81 648.51,-172.65"/>
</g>
</g>
</svg>
      <p class="diagram-caption">Built-in attrs use ns="" while extension attrs use their crate name</p>
    </div>

    <hr>

    <h2>The Grammar DSL</h2>

    <h3>Supported Variant Types</h3>
    <table>
      <thead>
        <tr><th>Type</th><th>Syntax</th><th>Example</th></tr>
      </thead>
      <tbody>
        <tr><td><strong>Unit</strong></td><td>Just the name</td><td><code>Skip</code> → <code>#[facet(ns::skip)]</code></td></tr>
        <tr><td><strong>Newtype</strong></td><td>Name with payload type</td><td><code>Rename(&amp;'static str)</code> → <code>#[facet(ns::rename = "foo")]</code></td></tr>
        <tr><td><strong>Struct</strong></td><td>Name with struct reference</td><td><code>Column(Column)</code> → <code>#[facet(ns::column(name = "id", primary_key))]</code></td></tr>
      </tbody>
    </table>

    <h3>Supported Field Types (in structs)</h3>
    <table>
      <thead>
        <tr><th>Grammar Type</th><th>Rust Type</th><th>Attribute Syntax</th></tr>
      </thead>
      <tbody>
        <tr><td><code>bool</code></td><td><code>bool</code></td><td><code>flag</code> or <code>flag = true</code></td></tr>
        <tr><td><code>&amp;'static str</code></td><td><code>&amp;'static str</code></td><td><code>name = "value"</code></td></tr>
        <tr><td><code>Option&lt;&amp;'static str&gt;</code></td><td><code>Option&lt;&amp;'static str&gt;</code></td><td><code>name = "value"</code> (optional)</td></tr>
        <tr><td><code>Option&lt;bool&gt;</code></td><td><code>Option&lt;bool&gt;</code></td><td><code>flag = true</code> (optional)</td></tr>
        <tr><td><code>i64</code></td><td><code>i64</code></td><td><code>min = 42</code> or <code>min = -100</code></td></tr>
        <tr><td><code>&amp;'static [&amp;'static str]</code></td><td><code>&amp;'static [&amp;'static str]</code></td><td><code>cols = ["a", "b"]</code></td></tr>
        <tr><td><code>ident</code></td><td><code>&amp;'static str</code></td><td><code>action = cascade</code> (bare ident → string)</td></tr>
      </tbody>
    </table>

    <h3>Example Grammar</h3>
<pre><code>facet::define_attr_grammar! {
    /// ORM attributes for database mapping
    pub enum Attr {
        /// Skip this field during serialization
        Skip,

        /// Rename the field
        Rename(&amp;'static str),

        /// Column configuration
        Column(Column),

        /// Index configuration
        Index(Index),
    }

    /// Database column configuration
    pub struct Column {
        /// Override column name
        pub name: Option&lt;&amp;'static str&gt;,
        /// SQL type override
        pub sql_type: Option&lt;&amp;'static str&gt;,
        /// Mark as primary key
        pub primary_key: bool,
        /// Enable auto-increment
        pub auto_increment: bool,
    }

    /// Index configuration
    pub struct Index {
        /// Custom index name
        pub name: Option&lt;&amp;'static str&gt;,
        /// Columns to index
        pub columns: &amp;'static [&amp;'static str],
        /// Unique constraint
        pub unique: bool,
    }
}</code></pre>

    <hr>

    <h2>Error Handling</h2>

    <h3>Unknown Attribute</h3>
<pre><code>#[facet(orm::colum(primary_key))]  // typo: "colum" instead of "column"</code></pre>
<pre><code>error: unknown attribute `colum`, did you mean `column`?
       available attributes: skip, rename, column, index
  --&gt; src/lib.rs:5:13
   |
5  |     #[facet(orm::colum(primary_key))]
   |                  ^^^^^</code></pre>

    <h3>Unknown Field</h3>
<pre><code>#[facet(orm::column(primay_key))]  // typo in field name</code></pre>
<pre><code>error: unknown field `primay_key` in `Column`
       available fields: name, sql_type, primary_key, auto_increment
       did you mean `primary_key`?
  --&gt; src/lib.rs:5:25
   |
5  |     #[facet(orm::column(primay_key))]
   |                         ^^^^^^^^^^</code></pre>

    <hr>

    <h2>What Gets Generated</h2>
    <p>When you call <code>define_attr_grammar!</code>, it generates:</p>

    <h3>1. Type Definitions</h3>
<pre><code>#[derive(Debug, Clone, PartialEq)]
pub enum Attr {
    Skip,
    Rename(&amp;'static str),
    Column(Column),
    Index(Index),
}

#[derive(Debug, Clone, PartialEq, Default)]
pub struct Column {
    pub name: Option&lt;&amp;'static str&gt;,
    pub sql_type: Option&lt;&amp;'static str&gt;,
    pub primary_key: bool,
    pub auto_increment: bool,
}</code></pre>

    <h3>2. Proc-Macro Re-exports</h3>
<pre><code>#[doc(hidden)]
pub use ::facet::__dispatch_attr;
#[doc(hidden)]
pub use ::facet::__build_struct_fields;
#[doc(hidden)]
pub use ::facet::__attr_error as __attr_error_proc_macro;
#[doc(hidden)]
pub use ::facet::__field_error as __field_error_proc_macro;</code></pre>

    <h3>3. The <code>__parse_attr!</code> Macro</h3>
    <p>A declarative macro containing the "compiled grammar":</p>
<pre><code>#[macro_export]
macro_rules! __parse_attr {
    ($name:ident $($rest:tt)*) =&gt; {
        $crate::__dispatch_attr!{
            @namespace { $crate }
            @enum_name { Attr }
            @variants {
                skip: unit,
                rename: newtype,
                column: rec Column { name: opt_string, primary_key: bool, ... },
                index: rec Index { name: opt_string, columns: list_string, unique: bool }
            }
            @name { $name }
            @rest { $($rest)* }
        }
    };

    () =&gt; {
        compile_error!("expected an attribute name")
    };
}</code></pre>

    <hr>

    <h2>The Derive Macro's Role</h2>
    <p>The <code>#[derive(Facet)]</code> macro is intentionally simple. When it sees <code>#[facet(orm::column(...))]</code>:</p>
    <ol>
      <li><strong>Parse</strong> the attribute to extract namespace (<code>orm</code>) and rest (<code>column(...)</code>)</li>
      <li><strong>Generate</strong> a call to <code>orm::__parse_attr!(column(...))</code></li>
      <li><strong>Done</strong> — all parsing logic lives in the extension crate</li>
    </ol>

<pre><code>// User writes:
#[facet(orm::column(primary_key))]
id: i64,

// Derive macro generates (simplified):
.attributes(&amp;[
    FieldAttribute::Extension(orm::__parse_attr!(column(primary_key)))
])</code></pre>

    <p>The derive macro doesn't need to understand ORM attributes. It just forwards to the namespace's parser.</p>

    <hr>

    <h2>Implementation Status</h2>

    <h3>Already Ported (from proto-attr to facet-macros-impl)</h3>
    <table>
      <thead>
        <tr><th>Component</th><th>File</th><th>Status</th></tr>
      </thead>
      <tbody>
        <tr><td>Grammar compiler</td><td><code>attr_grammar/make_parse_attr.rs</code></td><td class="status-done">✅ Done</td></tr>
        <tr><td>Dispatcher</td><td><code>attr_grammar/dispatch_attr.rs</code></td><td class="status-done">✅ Done</td></tr>
        <tr><td>Struct field builder</td><td><code>attr_grammar/build_struct_fields.rs</code></td><td class="status-done">✅ Done</td></tr>
        <tr><td>Attribute error</td><td><code>attr_grammar/attr_error.rs</code></td><td class="status-done">✅ Done</td></tr>
        <tr><td>Field error</td><td><code>attr_grammar/field_error.rs</code></td><td class="status-done">✅ Done</td></tr>
        <tr><td>Spanned error</td><td><code>attr_grammar/spanned_error.rs</code></td><td class="status-done">✅ Done</td></tr>
        <tr><td>Public API macro</td><td><code>facet/src/lib.rs</code></td><td class="status-done">✅ Done</td></tr>
      </tbody>
    </table>

    <h3>Not Yet Connected</h3>
    <table>
      <thead>
        <tr><th>Task</th><th>Status</th></tr>
      </thead>
      <tbody>
        <tr><td>Derive macro generates <code>ns::__parse_attr!</code> calls</td><td class="status-pending">❌ Not done</td></tr>
        <tr><td>Extension crates use <code>define_attr_grammar!</code></td><td class="status-pending">❌ Not done</td></tr>
        <tr><td>Built-in attrs use the grammar system</td><td class="status-pending">❌ Not done</td></tr>
      </tbody>
    </table>

    <hr>

    <h2>Migration Plan</h2>

    <h3>Phase 1: Connect the Derive Macro</h3>
    <p>Update <code>facet-macros-impl</code> to generate <code>namespace::__parse_attr!(...)</code> calls instead of the current <code>__attr!</code> dispatch.</p>

    <h3>Phase 2: Migrate Extension Crates</h3>
    <p>Convert <code>facet-kdl</code>, <code>facet-args</code>, <code>facet-yaml</code> to use <code>define_attr_grammar!</code>:</p>

<pre><code>// Before (hand-written in each crate):
#[macro_export]
macro_rules! __attr {
    (child { $($tt:tt)* }) =&gt; { $crate::__child!{ $($tt)* } };
    (property { $($tt:tt)* }) =&gt; { $crate::__property!{ $($tt)* } };
    // ... etc, ~100 lines per crate
}

// After (one grammar definition):
facet::define_attr_grammar! {
    pub enum Attr {
        Child,
        Children,
        Property,
        Argument,
        Arguments,
        NodeName,
    }
}</code></pre>

    <h3>Phase 3: Built-in Attributes</h3>
    <p>Use the grammar system for facet's built-in attributes too. This would replace the hand-written <code>FacetInner</code> enum (~200 lines of unsynn grammar).</p>

    <hr>

    <h2>Storage Model</h2>
    <p><strong>Everything becomes <code>ExtensionAttr</code>.</strong> This is the key insight.</p>

    <h3>Current (to be eliminated)</h3>
<pre><code>pub enum ShapeAttribute {
    DenyUnknownFields,           // ← specific variant, dies
    Default,                      // ← specific variant, dies
    Transparent,                  // ← specific variant, dies
    RenameAll(&amp;'static str),      // ← specific variant, dies
    Untagged,                     // ← specific variant, dies
    Tag(&amp;'static str),            // ← specific variant, dies
    Content(&amp;'static str),        // ← specific variant, dies
    Extension(ExtensionAttr),     // ← ONLY this remains
}</code></pre>

    <h3>Future</h3>
<pre><code>// ShapeAttribute and FieldAttribute both become just ExtensionAttr
pub type ShapeAttribute = ExtensionAttr;
pub type FieldAttribute = ExtensionAttr;</code></pre>

    <h3>Built-in Attrs as ExtensionAttr</h3>
    <p>Built-in facet attributes use empty namespace:</p>
<pre><code>// #[facet(rename_all = "camelCase")]
ExtensionAttr {
    ns: "",  // empty string = built-in facet attribute
    key: "rename_all",
    data: &amp;"camelCase" as *const (),
    shape: &lt;&amp;'static str&gt;::SHAPE,
}

// #[facet(kdl::child)]
ExtensionAttr {
    ns: "kdl",
    key: "child",
    data: &amp;() as *const (),
    shape: &lt;()&gt;::SHAPE,
}</code></pre>

    <h3>The Grammar Enum is for Parsing, Not Storage</h3>
    <p>The <code>Attr</code> enum generated by <code>define_attr_grammar!</code> is used:</p>
    <ol>
      <li><strong>At parse time</strong> — to validate syntax and produce good error messages</li>
      <li><strong>To generate ExtensionAttr</strong> — each variant knows its <code>key</code> and <code>data</code> type</li>
      <li><strong>For convenience</strong> — extension crates can match on typed enum in their code</li>
    </ol>
    <p>But the <strong>final storage</strong> is always <code>ExtensionAttr</code> in <code>Shape.attributes</code> / <code>Field.attributes</code>.</p>

    <hr>

    <h2>Summary</h2>
    <table>
      <thead>
        <tr><th>Aspect</th><th>Old (current)</th><th>New (with grammar)</th></tr>
      </thead>
      <tbody>
        <tr><td>Parsing logic</td><td>Hand-written per crate</td><td>Generated from grammar</td></tr>
        <tr><td>Error messages</td><td>Basic <code>compile_error!</code></td><td>Typo suggestions via strsim</td></tr>
        <tr><td>Type safety</td><td>Stringly-typed</td><td>Enum + struct types</td></tr>
        <tr><td>Boilerplate</td><td>~100 lines per crate</td><td>~10 lines grammar</td></tr>
        <tr><td>Maintenance</td><td>Fix bugs in N places</td><td>Fix once in generator</td></tr>
      </tbody>
    </table>

  </main>
</body>
</html>
