//! AUTO-GENERATED by cargo xtask gen-benchmarks
//! DO NOT EDIT - Edit facet-json/benches/benchmarks.kdl instead
//!
//! This file ensures parity: every benchmark has BOTH divan AND gungraun versions
//! for ALL 5 targets.

use divan::Bencher;
use facet::Facet;
use facet_format::jit as format_jit;
use facet_format_json::JsonParser;
use std::hint::black_box;

// ============================================================================
// Type Definitions
// ============================================================================

#[derive(Debug, PartialEq, Facet, serde::Serialize, serde::Deserialize, Clone)]
struct SimpleRecord {
    id: u64,
    name: String,
    active: bool,
}

#[derive(Debug, PartialEq, Facet, serde::Serialize, serde::Deserialize, Clone)]
struct Inner {
    x: i64,
    y: i64,
}

#[derive(Debug, PartialEq, Facet, serde::Serialize, serde::Deserialize, Clone)]
struct Outer {
    id: u64,
    inner: Inner,
    name: String,
}

#[derive(Debug, PartialEq, Facet, serde::Serialize, serde::Deserialize, Clone)]
struct WithOptions {
    id: u64,
    maybe_count: Option<i64>,
    maybe_flag: Option<bool>,
    maybe_value: Option<f64>,
}

// ============================================================================
// BENCHMARK: simple_struct
// ============================================================================

mod simple_struct {
    use super::*;

    static JSON: &[u8] = br#"{"id": 42, "name": "test", "active": true}"#;

    // ===== DIVAN (wall-clock) =====

    #[divan::bench]
    fn facet_format_jit_deserialize(bencher: Bencher) {
        bencher.bench(|| {
            black_box(
                format_jit::deserialize_with_fallback::<SimpleRecord, _>(JsonParser::new(
                    black_box(JSON),
                ))
                .unwrap(),
            )
        });
    }

    #[divan::bench]
    fn facet_format_json_deserialize(bencher: Bencher) {
        bencher.bench(|| {
            black_box(facet_format_json::from_slice::<SimpleRecord>(black_box(JSON)).unwrap())
        });
    }

    #[divan::bench]
    fn facet_json_deserialize(bencher: Bencher) {
        bencher
            .bench(|| black_box(facet_json::from_slice::<SimpleRecord>(black_box(JSON)).unwrap()));
    }

    #[cfg(feature = "cranelift")]
    #[divan::bench]
    fn facet_json_cranelift_deserialize(bencher: Bencher) {
        let json_str = unsafe { std::str::from_utf8_unchecked(JSON) };
        bencher.bench(|| {
            black_box(
                facet_json::cranelift::from_str_with_fallback::<SimpleRecord>(black_box(json_str))
                    .unwrap(),
            )
        });
    }

    #[divan::bench]
    fn serde_json_deserialize(bencher: Bencher) {
        bencher
            .bench(|| black_box(serde_json::from_slice::<SimpleRecord>(black_box(JSON)).unwrap()));
    }

    // ===== GUNGRAUN (instruction counts) =====

    fn setup_jit() -> &'static [u8] {
        let _ = format_jit::deserialize_with_fallback::<SimpleRecord, _>(JsonParser::new(JSON));
        JSON
    }

    #[gungraun::library_benchmark]
    #[bench::cached(setup = setup_jit)]
    fn gungraun_simple_struct_facet_format_jit(json: &[u8]) -> SimpleRecord {
        let parser = JsonParser::new(black_box(json));
        black_box(format_jit::deserialize_with_fallback::<SimpleRecord, _>(parser).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_simple_struct_facet_format_json_deserialize() -> SimpleRecord {
        black_box(facet_format_json::from_slice::<SimpleRecord>(black_box(JSON)).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_simple_struct_facet_json_deserialize() -> SimpleRecord {
        black_box(facet_json::from_slice::<SimpleRecord>(black_box(JSON)).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_simple_struct_serde_json_deserialize() -> SimpleRecord {
        black_box(serde_json::from_slice::<SimpleRecord>(black_box(JSON)).unwrap())
    }

    #[cfg(feature = "cranelift")]
    fn setup_cranelift() -> &'static str {
        let json_str = unsafe { std::str::from_utf8_unchecked(JSON) };
        let _ = facet_json::cranelift::from_str_with_fallback::<SimpleRecord>(json_str);
        json_str
    }

    #[cfg(feature = "cranelift")]
    #[gungraun::library_benchmark]
    #[bench::cached(setup = setup_cranelift)]
    fn gungraun_simple_struct_facet_json_cranelift(json: &str) -> SimpleRecord {
        black_box(
            facet_json::cranelift::from_str_with_fallback::<SimpleRecord>(black_box(json)).unwrap(),
        )
    }
}

// ============================================================================
// BENCHMARK: single_nested_struct
// ============================================================================

mod single_nested_struct {
    use super::*;

    static JSON: &[u8] = br#"{"id": 42, "inner": {"x": 10, "y": 20}, "name": "test"}"#;

    // ===== DIVAN (wall-clock) =====

    #[divan::bench]
    fn facet_format_jit_deserialize(bencher: Bencher) {
        bencher.bench(|| {
            black_box(
                format_jit::deserialize_with_fallback::<Outer, _>(JsonParser::new(black_box(JSON)))
                    .unwrap(),
            )
        });
    }

    #[divan::bench]
    fn facet_format_json_deserialize(bencher: Bencher) {
        bencher
            .bench(|| black_box(facet_format_json::from_slice::<Outer>(black_box(JSON)).unwrap()));
    }

    #[divan::bench]
    fn facet_json_deserialize(bencher: Bencher) {
        bencher.bench(|| black_box(facet_json::from_slice::<Outer>(black_box(JSON)).unwrap()));
    }

    #[cfg(feature = "cranelift")]
    #[divan::bench]
    fn facet_json_cranelift_deserialize(bencher: Bencher) {
        let json_str = unsafe { std::str::from_utf8_unchecked(JSON) };
        bencher.bench(|| {
            black_box(
                facet_json::cranelift::from_str_with_fallback::<Outer>(black_box(json_str))
                    .unwrap(),
            )
        });
    }

    #[divan::bench]
    fn serde_json_deserialize(bencher: Bencher) {
        bencher.bench(|| black_box(serde_json::from_slice::<Outer>(black_box(JSON)).unwrap()));
    }

    // ===== GUNGRAUN (instruction counts) =====

    fn setup_jit() -> &'static [u8] {
        let _ = format_jit::deserialize_with_fallback::<Outer, _>(JsonParser::new(JSON));
        JSON
    }

    #[gungraun::library_benchmark]
    #[bench::cached(setup = setup_jit)]
    fn gungraun_single_nested_struct_facet_format_jit(json: &[u8]) -> Outer {
        let parser = JsonParser::new(black_box(json));
        black_box(format_jit::deserialize_with_fallback::<Outer, _>(parser).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_single_nested_struct_facet_format_json_deserialize() -> Outer {
        black_box(facet_format_json::from_slice::<Outer>(black_box(JSON)).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_single_nested_struct_facet_json_deserialize() -> Outer {
        black_box(facet_json::from_slice::<Outer>(black_box(JSON)).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_single_nested_struct_serde_json_deserialize() -> Outer {
        black_box(serde_json::from_slice::<Outer>(black_box(JSON)).unwrap())
    }

    #[cfg(feature = "cranelift")]
    fn setup_cranelift() -> &'static str {
        let json_str = unsafe { std::str::from_utf8_unchecked(JSON) };
        let _ = facet_json::cranelift::from_str_with_fallback::<Outer>(json_str);
        json_str
    }

    #[cfg(feature = "cranelift")]
    #[gungraun::library_benchmark]
    #[bench::cached(setup = setup_cranelift)]
    fn gungraun_single_nested_struct_facet_json_cranelift(json: &str) -> Outer {
        black_box(facet_json::cranelift::from_str_with_fallback::<Outer>(black_box(json)).unwrap())
    }
}

// ============================================================================
// BENCHMARK: simple_with_options
// ============================================================================

mod simple_with_options {
    use super::*;

    static JSON: &[u8] =
        br#"{"id": 42, "maybe_count": 123, "maybe_flag": null, "maybe_value": 2.5}"#;

    // ===== DIVAN (wall-clock) =====

    #[divan::bench]
    fn facet_format_jit_deserialize(bencher: Bencher) {
        bencher.bench(|| {
            black_box(
                format_jit::deserialize_with_fallback::<WithOptions, _>(JsonParser::new(
                    black_box(JSON),
                ))
                .unwrap(),
            )
        });
    }

    #[divan::bench]
    fn facet_format_json_deserialize(bencher: Bencher) {
        bencher.bench(|| {
            black_box(facet_format_json::from_slice::<WithOptions>(black_box(JSON)).unwrap())
        });
    }

    #[divan::bench]
    fn facet_json_deserialize(bencher: Bencher) {
        bencher
            .bench(|| black_box(facet_json::from_slice::<WithOptions>(black_box(JSON)).unwrap()));
    }

    #[cfg(feature = "cranelift")]
    #[divan::bench]
    fn facet_json_cranelift_deserialize(bencher: Bencher) {
        let json_str = unsafe { std::str::from_utf8_unchecked(JSON) };
        bencher.bench(|| {
            black_box(
                facet_json::cranelift::from_str_with_fallback::<WithOptions>(black_box(json_str))
                    .unwrap(),
            )
        });
    }

    #[divan::bench]
    fn serde_json_deserialize(bencher: Bencher) {
        bencher
            .bench(|| black_box(serde_json::from_slice::<WithOptions>(black_box(JSON)).unwrap()));
    }

    // ===== GUNGRAUN (instruction counts) =====

    fn setup_jit() -> &'static [u8] {
        let _ = format_jit::deserialize_with_fallback::<WithOptions, _>(JsonParser::new(JSON));
        JSON
    }

    #[gungraun::library_benchmark]
    #[bench::cached(setup = setup_jit)]
    fn gungraun_simple_with_options_facet_format_jit(json: &[u8]) -> WithOptions {
        let parser = JsonParser::new(black_box(json));
        black_box(format_jit::deserialize_with_fallback::<WithOptions, _>(parser).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_simple_with_options_facet_format_json_deserialize() -> WithOptions {
        black_box(facet_format_json::from_slice::<WithOptions>(black_box(JSON)).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_simple_with_options_facet_json_deserialize() -> WithOptions {
        black_box(facet_json::from_slice::<WithOptions>(black_box(JSON)).unwrap())
    }

    #[gungraun::library_benchmark]
    fn gungraun_simple_with_options_serde_json_deserialize() -> WithOptions {
        black_box(serde_json::from_slice::<WithOptions>(black_box(JSON)).unwrap())
    }

    #[cfg(feature = "cranelift")]
    fn setup_cranelift() -> &'static str {
        let json_str = unsafe { std::str::from_utf8_unchecked(JSON) };
        let _ = facet_json::cranelift::from_str_with_fallback::<WithOptions>(json_str);
        json_str
    }

    #[cfg(feature = "cranelift")]
    #[gungraun::library_benchmark]
    #[bench::cached(setup = setup_cranelift)]
    fn gungraun_simple_with_options_facet_json_cranelift(json: &str) -> WithOptions {
        black_box(
            facet_json::cranelift::from_str_with_fallback::<WithOptions>(black_box(json)).unwrap(),
        )
    }
}

// ============================================================================
// Gungraun Benchmark Groups
// ============================================================================

// Re-export gungraun benchmarks (macro doesn't support :: paths)
use simple_struct::gungraun_simple_struct_facet_format_jit;
use simple_struct::gungraun_simple_struct_facet_format_json_deserialize as gungraun_simple_struct_facet_format_json;
#[cfg(feature = "cranelift")]
use simple_struct::gungraun_simple_struct_facet_json_cranelift;
use simple_struct::gungraun_simple_struct_facet_json_deserialize as gungraun_simple_struct_facet_json;
use simple_struct::gungraun_simple_struct_serde_json_deserialize as gungraun_simple_struct_serde_json;
use simple_with_options::gungraun_simple_with_options_facet_format_jit;
use simple_with_options::gungraun_simple_with_options_facet_format_json_deserialize as gungraun_simple_with_options_facet_format_json;
#[cfg(feature = "cranelift")]
use simple_with_options::gungraun_simple_with_options_facet_json_cranelift;
use simple_with_options::gungraun_simple_with_options_facet_json_deserialize as gungraun_simple_with_options_facet_json;
use simple_with_options::gungraun_simple_with_options_serde_json_deserialize as gungraun_simple_with_options_serde_json;
use single_nested_struct::gungraun_single_nested_struct_facet_format_jit;
use single_nested_struct::gungraun_single_nested_struct_facet_format_json_deserialize as gungraun_single_nested_struct_facet_format_json;
#[cfg(feature = "cranelift")]
use single_nested_struct::gungraun_single_nested_struct_facet_json_cranelift;
use single_nested_struct::gungraun_single_nested_struct_facet_json_deserialize as gungraun_single_nested_struct_facet_json;
use single_nested_struct::gungraun_single_nested_struct_serde_json_deserialize as gungraun_single_nested_struct_serde_json;

gungraun::library_benchmark_group!(
    name = simple_struct_benchmarks;
    benchmarks =
        gungraun_simple_struct_facet_format_jit,
        gungraun_simple_struct_facet_format_json,
        gungraun_simple_struct_facet_json,
        gungraun_simple_struct_serde_json,
);

#[cfg(feature = "cranelift")]
gungraun::library_benchmark_group!(
    name = simple_struct_cranelift;
    benchmarks = gungraun_simple_struct_facet_json_cranelift
);

gungraun::library_benchmark_group!(
    name = single_nested_struct_benchmarks;
    benchmarks =
        gungraun_single_nested_struct_facet_format_jit,
        gungraun_single_nested_struct_facet_format_json,
        gungraun_single_nested_struct_facet_json,
        gungraun_single_nested_struct_serde_json,
);

#[cfg(feature = "cranelift")]
gungraun::library_benchmark_group!(
    name = single_nested_struct_cranelift;
    benchmarks = gungraun_single_nested_struct_facet_json_cranelift
);

gungraun::library_benchmark_group!(
    name = simple_with_options_benchmarks;
    benchmarks =
        gungraun_simple_with_options_facet_format_jit,
        gungraun_simple_with_options_facet_format_json,
        gungraun_simple_with_options_facet_json,
        gungraun_simple_with_options_serde_json,
);

#[cfg(feature = "cranelift")]
gungraun::library_benchmark_group!(
    name = simple_with_options_cranelift;
    benchmarks = gungraun_simple_with_options_facet_json_cranelift
);

// Gungraun main
#[cfg(not(feature = "cranelift"))]
gungraun::main!(
    library_benchmark_groups = simple_struct_benchmarks,
    single_nested_struct_benchmarks,
    simple_with_options_benchmarks
);

#[cfg(feature = "cranelift")]
gungraun::main!(
    library_benchmark_groups = simple_struct_benchmarks,
    simple_struct_cranelift,
    single_nested_struct_benchmarks,
    single_nested_struct_cranelift,
    simple_with_options_benchmarks,
    simple_with_options_cranelift
);
