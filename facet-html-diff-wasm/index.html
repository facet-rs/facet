<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>facet-html-diff WASM Test Harness</title>
  <style>
    body { font-family: monospace; margin: 20px; }
    .pass { color: green; }
    .fail { color: red; }
    #results { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>facet-html-diff WASM Test Harness</h1>
  <div id="status">Loading WASM...</div>
  <div id="results"></div>
  
  <script type="module">
    import init, { apply_patches_json, set_body_inner_html, get_body_inner_html, diff_html, init_tracing } from './pkg/facet_html_diff_wasm.js';

    window.wasmReady = false;
    window.testResults = [];

    async function initWasm() {
      try {
        await init();
        init_tracing();
        window.wasmReady = true;
        document.getElementById('status').textContent = 'WASM loaded successfully';
        console.log('[test-harness] WASM initialized');
      } catch (e) {
        document.getElementById('status').textContent = 'WASM load failed: ' + e;
        console.error('[test-harness] WASM init failed:', e);
      }
    }

    // Expose WASM functions globally for Playwright
    window.setBodyInnerHtml = null;
    window.applyPatchesJson = null;
    window.getBodyInnerHtml = null;
    window.diffHtml = null;

    initWasm().then(() => {
      window.setBodyInnerHtml = set_body_inner_html;
      window.applyPatchesJson = apply_patches_json;
      window.getBodyInnerHtml = get_body_inner_html;
      window.diffHtml = diff_html;
    });

    // Run a single test case using WASM
    window.runTestCase = async function(testCase) {
      const { name, old_body_html, new_body_html, patches_json } = testCase;
      
      try {
        // Set initial HTML
        set_body_inner_html(old_body_html);
        
        // Apply patches via WASM
        apply_patches_json(patches_json);
        
        // Get result
        const result = get_body_inner_html();
        
        // Normalize both for comparison
        const normalizedResult = normalizeHtml(result);
        const normalizedExpected = normalizeHtml(new_body_html);
        
        if (normalizedResult === normalizedExpected) {
          return { pass: true };
        } else {
          return { 
            pass: false, 
            error: `Mismatch:\nExpected: ${normalizedExpected}\nGot: ${normalizedResult}`,
            result: normalizedResult,
            expected: normalizedExpected
          };
        }
      } catch (e) {
        return { pass: false, error: e.toString() };
      }
    };

    function normalizeHtml(html) {
      const temp = document.createElement('div');
      temp.innerHTML = html;
      return temp.innerHTML;
    }

    // Run all test cases
    window.runAllTests = async function(testCases) {
      const results = [];
      for (const tc of testCases) {
        const result = await window.runTestCase(tc);
        results.push({ name: tc.name, ...result });
        
        const status = result.pass ? '✓' : '✗';
        const className = result.pass ? 'pass' : 'fail';
        const el = document.createElement('div');
        el.className = className;
        el.textContent = `${status} ${tc.name}`;
        if (!result.pass) {
          el.textContent += '\n  ' + result.error;
        }
        document.getElementById('results').appendChild(el);
      }
      window.testResults = results;
      return results;
    };
  </script>
</body>
</html>
