# Nextest configuration for facet
# See: https://nexte.st/docs/configuration/

experimental = ["wrapper-scripts"]

[scripts.wrapper.valgrind]
# Run tests under valgrind with leak checking
# --leak-check=full: show details for each leak
# --show-leak-kinds=all: show all leak types for diagnostics
# --errors-for-leak-kinds=definite,indirect: only fail on real leaks
# --error-exitcode=1: exit with 1 if errors found
command = 'valgrind --leak-check=full --show-leak-kinds=all --errors-for-leak-kinds=definite,indirect --error-exitcode=1'

# Valgrind profile - runs tests under valgrind
[profile.valgrind]

[[profile.valgrind.scripts]]
# Apply valgrind wrapper to all tests on Linux, except flatten tests
# (flatten uses intentional Box::leak for 'static lifetimes in the solver)
platform = 'cfg(target_os = "linux")'
filter = 'not binary(/flatten/) & not test(test_reading_flat_structs)'
run-wrapper = 'valgrind'
