# Nextest configuration for facet
# See: https://nexte.st/docs/configuration/

experimental = ["wrapper-scripts", "setup-scripts"]

[scripts.setup.set-env]
command = 'scripts/setup-test-env.sh'

[profile.default]
[[profile.default.scripts]]
filter = 'all()'
setup = 'set-env'

[scripts.wrapper.valgrind]
# Run tests under valgrind with leak checking
# --leak-check=full: show details for each leak
# --show-leak-kinds=all: show all leak types for diagnostics
# --errors-for-leak-kinds=definite,indirect: only fail on real leaks
# --error-exitcode=1: exit with 1 if errors found
command = 'valgrind --leak-check=full --show-leak-kinds=all --errors-for-leak-kinds=definite,indirect --error-exitcode=1'

[scripts.wrapper.valgrind-lean]
# Run tests under valgrind without leak checking
# Faster than full leak detection, just catches runtime errors
# --error-exitcode=1: exit with 1 if errors found
# --track-origins=yes: show where uninitialized values come from
# --read-var-info=yes: include variable names and source locations
# --verbose: more detailed output
command = 'valgrind --error-exitcode=1 --track-origins=yes --read-var-info=yes --verbose'

[scripts.wrapper.lldb]
# Run tests under lldb to capture backtraces on crashes
# Useful for debugging SIGABRT, SIGSEGV, etc.
# Note: nextest runs from crate dirs, so we need workspace-relative path
command = '../scripts/lldb-wrapper.sh'

# Valgrind profile - runs tests under valgrind
[profile.valgrind]

[[profile.valgrind.scripts]]
# Apply valgrind wrapper to all tests (Linux/macOS with valgrind-macos)
filter = 'all()'
run-wrapper = 'valgrind'

# Valgrind-lean profile - runs tests under valgrind without leak checking
[profile.valgrind-lean]

[[profile.valgrind-lean.scripts]]
# Apply valgrind-lean wrapper to all tests (faster, no leak detection)
filter = 'all()'
run-wrapper = 'valgrind-lean'

# LLDB profile - runs tests under lldb to capture crash backtraces
[profile.lldb]

[[profile.lldb.scripts]]
# Apply lldb wrapper to all tests on macOS
platform = 'cfg(target_os = "macos")'
filter = 'all()'
run-wrapper = 'lldb'

# Debug profile - for attaching debugger with crash handler
[profile.debug]
# Allow 24 hours for manual debugging (crash handler sleeps for 60s)
slow-timeout = { period = "86400s" }
# Don't retry on failure
retries = 0
